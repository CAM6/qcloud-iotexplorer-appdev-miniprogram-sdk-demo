!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var r=t();for(var n in r)("object"==typeof exports?exports:e)[n]=r[n]}}(window,(function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=11)}([function(e,t,r){"use strict";r.r(t),r.d(t,"__extends",(function(){return o})),r.d(t,"__assign",(function(){return i})),r.d(t,"__rest",(function(){return s})),r.d(t,"__decorate",(function(){return c})),r.d(t,"__param",(function(){return a})),r.d(t,"__metadata",(function(){return u})),r.d(t,"__awaiter",(function(){return f})),r.d(t,"__generator",(function(){return l})),r.d(t,"__exportStar",(function(){return d})),r.d(t,"__values",(function(){return _})),r.d(t,"__read",(function(){return p})),r.d(t,"__spread",(function(){return h})),r.d(t,"__spreadArrays",(function(){return v})),r.d(t,"__await",(function(){return g})),r.d(t,"__asyncGenerator",(function(){return y})),r.d(t,"__asyncDelegator",(function(){return E})),r.d(t,"__asyncValues",(function(){return C})),r.d(t,"__makeTemplateObject",(function(){return m})),r.d(t,"__importStar",(function(){return T})),r.d(t,"__importDefault",(function(){return S}));var n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};function o(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var i=function(){return(i=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function s(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(e);o<n.length;o++)t.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(r[n[o]]=e[n[o]])}return r}function c(e,t,r,n){var o,i=arguments.length,s=i<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var c=e.length-1;c>=0;c--)(o=e[c])&&(s=(i<3?o(s):i>3?o(t,r,s):o(t,r))||s);return i>3&&s&&Object.defineProperty(t,r,s),s}function a(e,t){return function(r,n){t(r,n,e)}}function u(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function f(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{a(n.next(e))}catch(e){i(e)}}function c(e){try{a(n.throw(e))}catch(e){i(e)}}function a(e){e.done?o(e.value):new r((function(t){t(e.value)})).then(s,c)}a((n=n.apply(e,t||[])).next())}))}function l(e,t){var r,n,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(i){return function(c){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,n=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}}function d(e,t){for(var r in e)t.hasOwnProperty(r)||(t[r]=e[r])}function _(e){var t="function"==typeof Symbol&&e[Symbol.iterator],r=0;return t?t.call(e):{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}}}function p(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,i=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)s.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return s}function h(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(p(arguments[t]));return e}function v(){for(var e=0,t=0,r=arguments.length;t<r;t++)e+=arguments[t].length;var n=Array(e),o=0;for(t=0;t<r;t++)for(var i=arguments[t],s=0,c=i.length;s<c;s++,o++)n[o]=i[s];return n}function g(e){return this instanceof g?(this.v=e,this):new g(e)}function y(e,t,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n,o=r.apply(e,t||[]),i=[];return n={},s("next"),s("throw"),s("return"),n[Symbol.asyncIterator]=function(){return this},n;function s(e){o[e]&&(n[e]=function(t){return new Promise((function(r,n){i.push([e,t,r,n])>1||c(e,t)}))})}function c(e,t){try{(r=o[e](t)).value instanceof g?Promise.resolve(r.value.v).then(a,u):f(i[0][2],r)}catch(e){f(i[0][3],e)}var r}function a(e){c("next",e)}function u(e){c("throw",e)}function f(e,t){e(t),i.shift(),i.length&&c(i[0][0],i[0][1])}}function E(e){var t,r;return t={},n("next"),n("throw",(function(e){throw e})),n("return"),t[Symbol.iterator]=function(){return this},t;function n(n,o){t[n]=e[n]?function(t){return(r=!r)?{value:g(e[n](t)),done:"return"===n}:o?o(t):t}:o}}function C(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,r=e[Symbol.asyncIterator];return r?r.call(e):(e=_(e),t={},n("next"),n("throw"),n("return"),t[Symbol.asyncIterator]=function(){return this},t);function n(r){t[r]=e[r]&&function(t){return new Promise((function(n,o){(function(e,t,r,n){Promise.resolve(n).then((function(t){e({value:t,done:r})}),t)})(n,o,(t=e[r](t)).done,t.value)}))}}}function m(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e}function T(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function S(e){return e&&e.__esModule?e:{default:e}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.appendParams=function(e,r){void 0===r&&(r={});var n=[];return Object.keys(r).forEach((function(e){var o=r[e];if(void 0!==o){if(t.isPlainObject(o))try{o=JSON.stringify(o)}catch(e){}n.push(e+"="+encodeURIComponent(o))}})),n.length?(e.indexOf("?")>-1?e+"&":e+"?")+n.join("&"):e},t.delay=function(e){return new Promise((function(t){return setTimeout(t,e)}))},t.genPromise=function(){var e,t;return{promise:new Promise((function(r,n){e=r,t=n})),resolve:e,reject:t}},t.noop=function(){},t.getErrorMsg=function(e){if(e){var t="";return"string"==typeof e?e:(t=e.msg||e.Message||e.message||e.errMsg||"连接服务器失败，请稍后再试",e.reqId&&(t+="("+e.reqId+")"),t||(t="连接服务器失败，请稍后再试"),t)}},t.isPlainObject=function(e){if("object"!=(void 0===e?"undefined":typeof e)||null===e)return!1;for(var t=e;null!==Object.getPrototypeOf(t);)t=Object.getPrototypeOf(t);return Object.getPrototypeOf(e)===t}},function(e,t,r){"use strict";var n,o,i,s=r(17),c="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-";function a(){i=!1}function u(e){if(e){if(e!==n){if(e.length!==c.length)throw new Error("Custom alphabet for shortid must be "+c.length+" unique characters. You submitted "+e.length+" characters: "+e);var t=e.split("").filter((function(e,t,r){return t!==r.lastIndexOf(e)}));if(t.length)throw new Error("Custom alphabet for shortid must be "+c.length+" unique characters. These characters were not unique: "+t.join(", "));n=e,a()}}else n!==c&&(n=c,a())}function f(){return i||(i=function(){n||u(c);for(var e,t=n.split(""),r=[],o=s.nextValue();t.length>0;)o=s.nextValue(),e=Math.floor(o*t.length),r.push(t.splice(e,1)[0]);return r.join("")}())}e.exports={get:function(){return n||c},characters:function(e){return u(e),n},seed:function(e){s.seed(e),o!==e&&(a(),o=e)},lookup:function(e){return f()[e]},shuffled:f}},function(e,t,r){"use strict";var n;Object.defineProperty(t,"__esModule",{value:!0});var o,i=r(1);!function(e){e.Debug="Debug",e.Info="Info",e.Warn="Warn",e.Error="Error"}(o=t.LogLevel||(t.LogLevel={}));var s=((n={})[o.Debug]=console.log,n[o.Info]=console.info,n[o.Warn]=console.warn,n[o.Error]=console.error,n),c=function(){function e(){this.options={debug:!1}}return e.prototype._getLogger=function(e){return e in o||(e=o.Debug),this.options.debug?s[e].bind(console,"["+e+"]"):i.noop},e.prototype.config=function(e){Object.assign(this.options,e)},Object.defineProperty(e.prototype,"info",{get:function(){return this._getLogger(o.Info)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"debug",{get:function(){return this._getLogger(o.Debug)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"warn",{get:function(){return this._getLogger(o.Warn)},enumerable:!0,configurable:!0}),Object.defineProperty(e.prototype,"error",{get:function(){return this._getLogger(o.Error)},enumerable:!0,configurable:!0}),e}();t.default=new c},function(e,t,r){"use strict";var n,o,i,s;Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.Ready="ready",e.Error="error",e.WsError="ws_error",e.WsClose="ws_close",e.WsPush="wsPush",e.WsReport="wsReport",e.WsControl="wsControl",e.WsStatusChange="wsStatusChange"}(t.EventTypes||(t.EventTypes={})),function(e){e.UDP_NOT_RESPONSED="UDP_NOT_RESPONSED",e.SSID_NOT_MATCH="SSID_NOT_MATCH",e.CONNECT_SOFTAP_FAIL="CONNECT_SOFTAP_FAIL",e.CONNECT_TARGET_WIFI_FAIL="CONNECT_TARGET_WIFI_FAIL",e.UDP_ERROR="UDP_ERROR",e.UDP_CLOSED="UDP_CLOSED",e.DEVICE_ERROR="DEVICE_ERROR",e.INVALID_UDP_RESPONSE="INVALID_UDP_RESPONSE",e.DEVICE_CONNECT_MQTT_FAIL="DEVICE_CONNECT_MQTT_FAIL",e.DEVICE_CONNECT_WIFI_FAIL="DEVICE_CONNECT_WIFI_FAIL",e.ADD_DEVICE_FAIL="ADD_DEVICE_FAIL",e.SEND_UDP_MSG_FAIL="SEND_UDP_MSG_FAIL"}(i=t.ConnectDeviceErrorCode||(t.ConnectDeviceErrorCode={})),t.SoftApErrorMsg=((n={})[i.UDP_NOT_RESPONSED]="超时未收到设备响应",n[i.CONNECT_SOFTAP_FAIL]="手机连接设备热点失败",n[i.CONNECT_TARGET_WIFI_FAIL]="手机连接WiFi路由器失败",n[i.UDP_ERROR]="连接设备失败",n[i.UDP_CLOSED]="连接设备中断",n[i.DEVICE_ERROR]="设备配网异常",n[i.INVALID_UDP_RESPONSE]="设备响应报文格式错误",n[i.DEVICE_CONNECT_MQTT_FAIL]="连接云端失败",n[i.DEVICE_CONNECT_WIFI_FAIL]="设备连接WiFi路由器失败",n[i.ADD_DEVICE_FAIL]="添加设备失败",n[i.SEND_UDP_MSG_FAIL]="发送配网消息失败",n),function(e){e.CONNECT_DEVICE_START="CONNECT_DEVICE_START",e.CONNECT_SOFTAP_START="CONNECT_SOFTAP_START",e.CONNECT_SOFTAP_SUCCESS="CONNECT_SOFTAP_SUCCESS",e.CREATE_UDP_CONNECTION_START="CREATE_UDP_CONNECTION_START",e.CREATE_UDP_CONNECTION_SUCCESS="CREATE_UDP_CONNECTION_SUCCESS",e.SEND_TARGET_WIFIINFO_START="SEND_TARGET_WIFIINFO_START",e.SEND_TARGET_WIFIINFO_SUCCESS="SEND_TARGET_WIFIINFO_SUCCESS",e.GET_DEVICE_SIGNATURE_START="GET_DEVICE_SIGNATURE_START",e.GET_DEVICE_SIGNATURE_SUCCESS="GET_DEVICE_SIGNATURE_SUCCESS",e.CONNECT_TARGET_WIFI_START="RECONNECT_TARGET_WIFI_START",e.CONNECT_TARGET_WIFI_SUCCESS="RECONNECT_TARGET_WIFI_SUCCESS",e.ADD_DEVICE_START="ADD_DEVICE_START",e.ADD_DEVICE_SUCCESS="ADD_DEVICE_SUCCESS",e.CONNECT_DEVICE_SUCCESS="CONNECT_DEVICE_SUCCESS"}(s=t.ConnectDeviceStepCode||(t.ConnectDeviceStepCode={})),t.SoftApStepMsg=((o={})[s.CONNECT_DEVICE_START]="开始配网",o[s.CONNECT_SOFTAP_START]="开始连接设备热点",o[s.CONNECT_SOFTAP_SUCCESS]="连接设备热点成功",o[s.CREATE_UDP_CONNECTION_START]="开始与设备建立UDP连接",o[s.CREATE_UDP_CONNECTION_SUCCESS]="与设备建立UDP连接成功",o[s.SEND_TARGET_WIFIINFO_START]="开始发送目标WiFi信息至设备",o[s.SEND_TARGET_WIFIINFO_SUCCESS]="发送目标WiFi信息至设备成功",o[s.GET_DEVICE_SIGNATURE_START]="开始获取设备签名",o[s.GET_DEVICE_SIGNATURE_SUCCESS]="获取设备签名成功",o[s.CONNECT_TARGET_WIFI_START]="手机开始连接目标WiFi",o[s.CONNECT_TARGET_WIFI_SUCCESS]="手机连接目标WiFi成功",o[s.ADD_DEVICE_START]="开始添加设备",o[s.ADD_DEVICE_SUCCESS]="添加设备成功",o[s.CONNECT_DEVICE_SUCCESS]="配网成功",o)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=Object.defineProperty,o=Object.create,i=Object.prototype.hasOwnProperty,s={configurable:!0,enumerable:!1,writable:!0,value:null};function c(e){if("function"!=typeof e)throw new TypeError(e+" is not a function");return e}var a=function(){function e(){}return e.prototype.on=function(e,t){var r;return c(t),i.call(this,"__ee__")?r=this.__ee__:(r=s.value=o(null),n(this,"__ee__",s),s.value=null),r[e]?r[e].push(t):r[e]=[t],this},e.prototype.once=function(e,t){var r,n=this;return c(t),this.on.call(this,e,r=function(){for(var o=[],i=0;i<arguments.length;i++)o[i]=arguments[i];n.off.call(void 0,e,r),t.apply(n,o)}),this},e.prototype.off=function(e,t){if(!i.call(this,"__ee__"))return this;var r=this.__ee__;if(!r[e])return this;if(t){var n=r[e]||[],o=n.indexOf(t);o>-1&&n.splice(o,1)}else r[e].length=0;return this},e.prototype.emit=function(e){for(var t=this,r=[],n=1;n<arguments.length;n++)r[n-1]=arguments[n];if(i.call(this,"__ee__")){var o=this.__ee__[e];o&&o.length&&o.forEach((function(e){return e.apply(t,r)}))}},e}();t.default=a},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(0);t.pify=function(e,t){return void 0===t&&(t=wx),function(r){for(var o=[],i=1;i<arguments.length;i++)o[i-1]=arguments[i];return new Promise((function(i,s){e?e.call.apply(e,n.__spread([t,n.__assign(n.__assign({},r),{success:i,fail:s})],o)):wx.showModal({title:"提示",content:"当前微信版本过低，无法使用该功能，请升级到最新微信版本后重试",complete:function(){return s()},confirmColor:"#006eff",showCancel:!1})}))}}},function(e,t,r){"use strict";var n=r(2),o=r(18),i=r(22),s=r(23)||0;function c(){return o(s)}e.exports=c,e.exports.generate=c,e.exports.seed=function(t){return n.seed(t),e.exports},e.exports.worker=function(t){return s=t,e.exports},e.exports.characters=function(e){return void 0!==e&&n.characters(e),n.shuffled()},e.exports.isValid=i},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(0);t.normalizeError=function(e){return e&&(e.errMsg&&["auth deny","scope unauthorized"].some((function(t){return String(e.errMsg).indexOf(t)>-1}))?Object.assign(e,{code:"UserNeedAuth",msg:"尚未开启微信基本信息授权，请授权后使用"}):t.isVerifyLoginError(e)&&(e=t.genVerifyLoginFailError(e))),e},t.genVerifyLoginFailError=function(e){e||(e={});e.code,e.msg;var t=e.reqId,r=n.__rest(e,["code","msg","reqId"]);return n.__assign({code:"VERIFY_LOGIN_FAILED",msg:"登录态验证失败，请重新登录",reqId:t},r)},t.isVerifyLoginError=function(e){return e&&String(e.code||"").indexOf("InvalidAccessToken")>-1},t.handleVerifyLoginError=function(e){if(t.isVerifyLoginError(e))throw t.genVerifyLoginFailError(e)}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(0);n.__exportStar(r(10),t),n.__exportStar(r(16),t)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(0),o=n.__importDefault(r(15)),i=r(6),s=0;t.request=function(e){return n.__awaiter(void 0,void 0,void 0,(function(){var t,r=e.url,c=e.data,a=e.header,u=void 0===a?{}:a,f=e.method,l=void 0===f?"get":f,d=e.dataType,_=e.responseType,p=n.__rest(e,["url","data","header","method","dataType","responseType"]);return n.__generator(this,(function(e){switch(e.label){case 0:e.trys.push([0,5,6,7]),e.label=1;case 1:return s>=10?[4,o.default.startBlocking()]:[3,3];case 2:return e.sent(),[3,1];case 3:return s++,[4,i.pify(wx.request)(n.__assign({url:r,data:c,header:u,method:l,dataType:d,responseType:_},p))];case 4:return[2,e.sent()];case 5:return t=e.sent(),[2,Promise.reject(t)];case 6:return s--,o.default.resolveFirstBlock(),[7];case 7:return[2]}}))}))}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(0);n.__exportStar(r(4),t),n.__exportStar(r(12),t)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(0);r(13);var o=r(14),i=n.__importDefault(r(5)),s=r(25),c=n.__importDefault(r(3)),a=r(29),u=r(4),f=r(1),l=r(9),d=r(8),_=r(30),p=function(e){function t(t){var r=t.getAccessToken,i=t.appKey,a=void 0===i?"":i,f=t.apiPlatform,l=void 0===f?"":f,d=t.debug,_=void 0!==d&&d,p=t.wsConfig,h=void 0===p?{}:p,v=h.autoReconnect,g=void 0===v||v,y=h.disconnectWhenAppHide,E=void 0===y||y,C=h.connectWhenAppShow,m=void 0===C||C,T=n.__rest(h,["autoReconnect","disconnectWhenAppHide","connectWhenAppShow"]),S=e.call(this)||this;return S.isManuallyClose=!1,S._defaultFamilyIdPromise=null,c.default.config({debug:_}),S.ws=new s.IotWebsocket(S,n.__assign(n.__assign({},T),{apiPlatform:l})),S.loginManager=new o.LoginManager(S,{getAccessToken:r,appKey:a}),S._apiPlatform=l,S.ws.on("error",(function(e){c.default.debug("websocket error",e),S.emit(u.EventTypes.WsError,e),g&&S._reconnectWs()})),S.ws.on("close",(function(e){var t=void 0===e?{}:e,r=t.code,n=t.reason;c.default.debug("websocket close",{code:r,reason:n}),S.emit(u.EventTypes.WsClose,{code:r,reason:n}),g&&S._onWebsocketClose()})),S.ws.on("push",(function(e){return S._handlePushEvent(e)})),wx.onAppHide((function(){E&&(S.isManuallyClose=!0,S.ws.disconnect())})),wx.onAppShow((function(){m&&S.isLogin&&S.ws.connect()})),S}return n.__extends(t,e),Object.defineProperty(t.prototype,"userInfo",{get:function(){return this.loginManager.userInfo},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isLogin",{get:function(){return this.loginManager.isLogin},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"userId",{get:function(){return this.loginManager.userId},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"nickName",{get:function(){return this.loginManager.nickName},enumerable:!0,configurable:!0}),t.prototype.init=function(e){return void 0===e&&(e=!1),n.__awaiter(this,void 0,void 0,(function(){var t=this;return n.__generator(this,(function(r){return e&&(this._initPromise=null),[2,this._initPromise||(this._initPromise=new Promise((function(e,r){return n.__awaiter(t,void 0,void 0,(function(){var t;return n.__generator(this,(function(n){switch(n.label){case 0:return n.trys.push([0,3,,4]),[4,this.loginManager.login()];case 1:return n.sent(),[4,this.ws.connect()];case 2:return n.sent(),e(),[3,4];case 3:return t=n.sent(),r(d.normalizeError(t)),this._initPromise=null,[3,4];case 4:return[2]}}))}))})))]}))}))},t.prototype.getDefaultFamilyId=function(){var e=this;return this._defaultFamilyIdPromise||(this._defaultFamilyIdPromise=new Promise((function(t,r){return n.__awaiter(e,void 0,void 0,(function(){var e,o,i,s;return n.__generator(this,(function(n){switch(n.label){case 0:return n.trys.push([0,4,,5]),[4,this.requestApi("AppGetFamilyList",{Offset:0,Limit:100})];case 1:return e=n.sent(),o=e.FamilyList,e.Total?[3,3]:[4,this.requestApi("AppCreateFamily",{Name:this.loginManager.nickName})];case 2:return i=n.sent().Data.FamilyId,[2,t(i)];case 3:return t(o[0].FamilyId),[3,5];case 4:return s=n.sent(),r(s),this._defaultFamilyIdPromise=null,[3,5];case 5:return[2]}}))}))})))},t.prototype.sendWebsocketMessage=function(e,t){return void 0===t&&(t={}),n.__awaiter(this,void 0,void 0,(function(){return n.__generator(this,(function(r){switch(r.label){case 0:return[4,this.init()];case 1:return r.sent(),[2,this.ws.send(e,t)]}}))}))},t.prototype.connectWebsocket=function(){return n.__awaiter(this,void 0,void 0,(function(){return n.__generator(this,(function(e){switch(e.label){case 0:return[4,this.init()];case 1:return e.sent(),[4,this.ws.connect()];case 2:return e.sent(),[2]}}))}))},t.prototype.disconnectWebsocket=function(){this.ws.disconnect()},t.prototype.subscribeDevices=function(e){return n.__awaiter(this,void 0,void 0,(function(){return n.__generator(this,(function(t){return this.ws.subscribe((e||[]).map((function(e){return"string"==typeof e?e:e&&e.DeviceId?e.DeviceId:void 0})).filter(Boolean)),[2]}))}))},t.prototype.requestApi=function(e,t,r){void 0===t&&(t={}),void 0===r&&(r={});var o=r.doNotRetry,i=void 0!==o&&o,s=r.needLogin,a=void 0===s||s,u=n.__rest(r,["doNotRetry","needLogin"]);return n.__awaiter(this,void 0,void 0,(function(){var r,o,s,f,_,p,h;return n.__generator(this,(function(v){switch(v.label){case 0:return v.trys.push([0,6,,13]),a?[4,this.loginManager.checkLogin()]:[3,2];case 1:v.sent(),v.label=2;case 2:return r=this.loginManager,o=r.accessToken,s=r.userId,t&&"default"===t.FamilyId?(f=t,[4,this.getDefaultFamilyId()]):[3,4];case 3:f.FamilyId=v.sent(),v.label=4;case 4:return _=n.__assign({uin:s},t),o&&(_.AccessToken=o),this._apiPlatform&&(_.Platform=this._apiPlatform),[4,l.requestTokenApi(e,_,u)];case 5:return[2,v.sent()];case 6:if(p=v.sent(),c.default.debug("requestApi fail",p),!d.isVerifyLoginError(p))return[3,12];if(i)return[3,11];v.label=7;case 7:return v.trys.push([7,9,,10]),[4,this.loginManager.reLogin()];case 8:return v.sent(),[3,10];case 9:return h=v.sent(),c.default.error("reLogin fail",h),[2,Promise.reject(d.genVerifyLoginFailError(p))];case 10:return[2,this.requestApi(e,t,n.__assign({doNotRetry:!0},u))];case 11:return[2,Promise.reject(d.genVerifyLoginFailError(p))];case 12:return[2,Promise.reject(d.normalizeError(p))];case 13:return[2]}}))}))},t.prototype.connectDevice=function(e){return _.connectDevice(this,e)},t.prototype._handlePushEvent=function(e){e||(e={}),this.emit(u.EventTypes.WsPush,e);var t=e.action,r=e.params;r||(r={}),c.default.debug("actions updateDeviceDataByPush",e);var n=r.DeviceId,o=r.Type,i=r.SubType,s=r.Payload,f=r.Time,l=new Date(f).getTime();switch(t){case"DeviceChange":switch(o){case"Property":case"Shadow":case"Template":switch(i){case"Report":var d={};try{var _=JSON.parse(a.decodeBase64(s));if(c.default.debug("actions updateDeviceData payload",_),_){var p=_.type,h=_.state,v=_.method,g=_.params;if(p&&"update"===p&&h&&h.reported&&(v="report",g=h.reported),g||(g={}),"report"===v)for(var y in g)d[y]={Value:g[y],lastUpdate:l}}}catch(e){c.default.error("handle report event error",e)}this.emit(u.EventTypes.WsReport,{deviceId:n,deviceData:d});break;case"Push":d={};try{if(s){p=s.type,_=s.payload,v=s.method,g=s.params;if(p&&"delta"===p&&_&&_.state&&(v="control",g=_.state),"control"===v&&g){for(var y in g)d[y]={Value:g[y],LastUpdate:l};this.emit(u.EventTypes.WsControl,{deviceId:n,deviceData:d})}}}catch(e){c.default.error(e)}}break;case"StatusChange":var E="Online"===i?1:0;this.emit(u.EventTypes.WsStatusChange,{deviceId:n,deviceStatus:E})}}},t.prototype._onWebsocketClose=function(){if(!this.isManuallyClose)return this._reconnectWs();this.isManuallyClose=!1},t.prototype._reconnectWs=function(){return n.__awaiter(this,void 0,void 0,(function(){var e;return n.__generator(this,(function(t){switch(t.label){case 0:return t.trys.push([0,3,,4]),c.default.debug("websocket reconnecting in 2 seconds"),[4,f.delay(2e3)];case 1:return t.sent(),[4,this.ws.connect()];case 2:return t.sent(),[3,4];case 3:return e=t.sent(),c.default.error("error when reconnect ws",e),[2,Promise.reject(e)];case 4:return[2]}}))}))},t}(i.default);t.QcloudIotExplorerAppDevSdk=p},function(e,t){},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(0),o=n.__importDefault(r(5)),i=r(9),s=n.__importDefault(r(24)),c=r(8),a=n.__importDefault(r(3)),u="__qcloud-iotexplorer-appdev-sdk-accessToken",f=function(e){function t(t,r){var n=r.getAccessToken,o=r.appKey,i=e.call(this)||this;return i.accessToken="",i.appKey="",i.isLogin=!1,i.userInfo=null,i.sdk=t,i.getAccessToken=n,i.appKey=o,i}return n.__extends(t,e),t.prototype.login=function(){return n.__awaiter(this,void 0,void 0,(function(){var e,t,r,o,f;return n.__generator(this,(function(n){switch(n.label){case 0:e=!1,n.label=1;case 1:return n.trys.push([1,7,,10]),[4,s.default.getItem(u)];case 2:return(t=n.sent())?[3,4]:[4,this.getAccessToken()];case 3:return r=n.sent().Token,t=r,[3,5];case 4:e=!0,n.label=5;case 5:return[4,i.requestTokenApi("AppGetUser",{AccessToken:t})];case 6:return o=n.sent().Data,s.default.setItem(u,t),this.accessToken=t,this.userInfo=o,this.isLogin=!0,[3,10];case 7:return f=n.sent(),c.isVerifyLoginError(f)?[4,this.logout()]:[3,9];case 8:if(n.sent(),e)return a.default.debug("Cached Token expired, retrying..."),[2,this.login()];n.label=9;case 9:return[2,Promise.reject(f)];case 10:return[2]}}))}))},Object.defineProperty(t.prototype,"userId",{get:function(){return this.userInfo?this.userInfo.UserID:""},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"nickName",{get:function(){return this.userInfo?this.userInfo.NickName:""},enumerable:!0,configurable:!0}),t.prototype.checkLogin=function(){if(!this.isLogin)throw c.genVerifyLoginFailError()},t.prototype.logout=function(){return n.__awaiter(this,void 0,void 0,(function(){return n.__generator(this,(function(e){switch(e.label){case 0:return[4,s.default.removeItem(u)];case 1:return e.sent(),this.accessToken="",this.isLogin=!1,[2]}}))}))},t.prototype.reLogin=function(){return n.__awaiter(this,void 0,void 0,(function(){return n.__generator(this,(function(e){switch(e.label){case 0:return[4,this.logout()];case 1:return e.sent(),[4,this.login()];case 2:return e.sent(),[2]}}))}))},t}(o.default);t.LoginManager=f},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=[];t.default={resolveFirstBlock:function(){n.length&&(n[0].resolve(),n.shift())},startBlocking:function(){var e,t=new Promise((function(t){e=t}));return n.push({promise:t,resolve:e}),t}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(0),o=n.__importDefault(r(7)),i=r(1),s=r(10);t.requestTokenApi=function(e,t,r){return void 0===t&&(t={}),void 0===r&&(r={}),n.__awaiter(void 0,void 0,void 0,(function(){var c,a,u,f,l,d,_,p,h,v=t.uin,g=t.AccessToken,y=n.__rest(t,["uin","AccessToken"]),E=r.method,C=void 0===E?"POST":E,m=n.__rest(r,["method"]);return n.__generator(this,(function(t){switch(t.label){case 0:return a=o.default(),u={uin:v,cmd:e},y=Object.assign({},y,{Action:e,RequestId:a,AccessToken:g}),f=i.appendParams(m.url||"https://iot.cloud.tencent.com/api/exploreropen/tokenapi",u),c=n.__assign({url:f,data:y,method:C},m),[4,s.request(c)];case 1:if(l=t.sent().data,d=l.code,_=l.msg,p=l.data,h=void 0===p?{}:p,d){if(h){if(h.Error)throw{code:h.Error.Code,msg:h.Error.Message,reqId:a};throw{code:d,msg:_,reqId:a}}throw{code:d,msg:_}}return[2,h]}}))}))}},function(e,t,r){"use strict";var n=1;e.exports={nextValue:function(){return(n=(9301*n+49297)%233280)/233280},seed:function(e){n=e}}},function(e,t,r){"use strict";var n,o,i=r(19),s=(r(2),1459707606518),c=6;e.exports=function(e){var t="",r=Math.floor(.001*(Date.now()-s));return r===o?n++:(n=0,o=r),t+=i(c),t+=i(e),n>0&&(t+=i(n)),t+=i(r)}},function(e,t,r){"use strict";var n=r(2),o=r(20),i=r(21);e.exports=function(e){for(var t,r=0,s="";!t;)s+=i(o,n.get(),1),t=e<Math.pow(16,r+1),r++;return s}},function(e,t,r){"use strict";var n,o="object"==typeof window&&(window.crypto||window.msCrypto);n=o&&o.getRandomValues?function(e){return o.getRandomValues(new Uint8Array(e))}:function(e){for(var t=[],r=0;r<e;r++)t.push(Math.floor(256*Math.random()));return t},e.exports=n},function(e,t){e.exports=function(e,t,r){for(var n=(2<<Math.log(t.length-1)/Math.LN2)-1,o=Math.ceil(1.6*n*r/t.length),i="";;)for(var s=e(o),c=0;c<o;c++){var a=s[c]&n;if(t[a]&&(i+=t[a]).length===r)return i}}},function(e,t,r){"use strict";var n=r(2);e.exports=function(e){return!(!e||"string"!=typeof e||e.length<6)&&!new RegExp("[^"+n.get().replace(/[|\\{}()[\]^$+*?.-]/g,"\\$&")+"]").test(e)}},function(e,t,r){"use strict";e.exports=0},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(0),o=r(6);t.default={getItem:function(e){return n.__awaiter(this,void 0,void 0,(function(){return n.__generator(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,o.pify(wx.getStorage)({key:e})];case 1:return[2,t.sent().data];case 2:return t.sent(),[2,null];case 3:return[2]}}))}))},setItem:function(e,t){return n.__awaiter(this,void 0,void 0,(function(){var r;return n.__generator(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,o.pify(wx.setStorage)({key:e,data:t})];case 1:return n.sent(),[3,3];case 2:return r=n.sent(),console.error("setStorage error",r),[3,3];case 3:return[2]}}))}))},removeItem:function(e){return n.__awaiter(this,void 0,void 0,(function(){var t;return n.__generator(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,o.pify(wx.removeStorage)({key:e})];case 1:return r.sent(),[3,3];case 2:return t=r.sent(),console.error("removeStorage error",t),[3,3];case 3:return[2]}}))}))}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(0),o=n.__importDefault(r(5)),i=n.__importDefault(r(7)),s=r(1),c=r(26),a=n.__importDefault(r(3)),u=r(8),f={url:"wss://iot.cloud.tencent.com/ws/explorer",heartbeatInterval:6e4},l=function(e){function t(t,r){var n=e.call(this)||this;return n.sdk=t,n.requestHandlerMap={},n.options=Object.assign({},f,r),n._connected=!1,n._subscribeDeviceIdList=[],n._heartBeatTimer=null,n}return n.__extends(t,e),t.prototype.isConnected=function(){return!!this._connected},t.prototype.doConnectWs=function(){return n.__awaiter(this,void 0,void 0,(function(){var e=this;return n.__generator(this,(function(t){return[2,this._doConnectWsPromise||(this._doConnectWsPromise=new Promise((function(t,r){return n.__awaiter(e,void 0,void 0,(function(){var e,o,i=this;return n.__generator(this,(function(u){e=function(e){r(e),i.emit("error",e),i.disconnect()};try{o=this.options.url,this.ws=new c.WebSocket(s.appendParams(o,{uin:this.sdk.loginManager.userId})),this.ws.onOpen((function(){a.default.debug("websocket connected"),i._connected=!0,i.emit("connect"),t()})),this.ws.onError(e),this.ws.onMessage((function(e){var t=e.data;i.emit("message",t);try{t=JSON.parse(t)}catch(e){return void a.default.warn("onMessage parse event.data error: "+t)}t.push?i.emit("push",t):void 0!==t.reqId&&i.requestHandlerMap[t.reqId]&&i.requestHandlerMap[t.reqId](null,t)})),this.ws.onClose((function(e){return n.__awaiter(i,void 0,void 0,(function(){return n.__generator(this,(function(t){return a.default.debug("websocket closed"),this.disconnect(),this.emit("close",e),[2]}))}))}))}catch(t){e(t)}return[2]}))}))})))]}))}))},t.prototype.connect=function(){return n.__awaiter(this,void 0,void 0,(function(){return n.__generator(this,(function(e){switch(e.label){case 0:return[4,this.sdk.loginManager.checkLogin()];case 1:return e.sent(),this.isConnected()?[3,3]:[4,this.doConnectWs()];case 2:e.sent(),e.label=3;case 3:return[2,this.activePush()]}}))}))},t.prototype.subscribe=function(e){return this.activePush(e)},t.prototype.disconnect=function(){if(this.ws){this.ws.close({}),this._connected=!1,this._doConnectWsPromise=null,this.ws=null,clearInterval(this._heartBeatTimer),this._heartBeatTimer=null}},t.prototype.send=function(e,t,r){void 0===t&&(t={});var o=(void 0===r?{}:r).reqId;return n.__awaiter(this,void 0,void 0,(function(){var r=this;return n.__generator(this,(function(n){switch(n.label){case 0:if(o||(o=i.default()),!this.ws)return[3,5];this.ws.send({data:JSON.stringify({action:e,reqId:o,params:t})}),n.label=1;case 1:return n.trys.push([1,,3,4]),[4,Promise.race([new Promise((function(e,t){r.requestHandlerMap[o]=function(r,n){if(!r)return n.data||!n.error&&!n.error_message?e(n.data):t({code:n.error,msg:n.error_message});t(r)}})),new Promise((function(e,t){setTimeout((function(){t({code:"TIMEOUT"})}),2e4)}))])];case 2:return[2,n.sent()];case 3:return delete this.requestHandlerMap[o],[7];case 4:return[3,6];case 5:a.default.warn("Try send ws message but no ws instance",e,t),n.label=6;case 6:return[2]}}))}))},t.prototype.callYunApi=function(e,t,r){void 0===t&&(t={});var o=(void 0===r?{}:r).doNotRetry;return n.__awaiter(this,void 0,void 0,(function(){var r,c,f,l,d,_,p,h,v,g,y,E;return n.__generator(this,(function(n){switch(n.label){case 0:r=i.default(),c=this.sdk.loginManager,f=c.accessToken,l=c.appKey,(t=Object.assign({},t,{RequestId:r})).AccessToken=f,d={Action:e,ActionParams:t},this.options.apiPlatform?d.Platform=this.options.apiPlatform:d.AppKey=l,a.default.debug("yunapi start("+r+") => ",d),n.label=1;case 1:return n.trys.push([1,3,,11]),[4,this.send("YunApi",d,{reqId:r})];case 2:if(!(_=n.sent()))throw a.default.error("empty response",d),{msg:"连接服务器失败，请稍后重试"};if(!(p=_.Response))throw a.default.error("empty response",d,p),{msg:"连接服务器失败，请稍后重试"};if(h=p.Error,v=p.error,g=p.error_message,h)throw{code:h.Code,msg:h.Message};if(v)throw{code:v,msg:g};return a.default.debug("yunapi success("+r+") => ",d,p),[2,p];case 3:if(y=n.sent(),a.default.error("yunapi fail("+r+") => ",y),!u.isVerifyLoginError(y))return[3,10];if(o)return[3,8];n.label=4;case 4:return n.trys.push([4,6,,7]),[4,this.sdk.loginManager.reLogin()];case 5:return n.sent(),[3,7];case 6:return E=n.sent(),a.default.error("reLogin fail",E),[2,Promise.reject(u.genVerifyLoginFailError(y))];case 7:return[2,this.callYunApi(e,t,{doNotRetry:!0})];case 8:return[4,this.sdk.loginManager.logout()];case 9:return n.sent(),[2,u.genVerifyLoginFailError(y)];case 10:return s.isPlainObject(y)&&(y.reqId=r),[2,Promise.reject(y)];case 11:return[2]}}))}))},t.prototype.sendWsHeatBeat=function(){if(this._subscribeDeviceIdList&&this._subscribeDeviceIdList.length)return this.callYunApi("AppDeviceTraceHeartBeat",{DeviceIds:this._subscribeDeviceIdList})},t.prototype.activePush=function(e){var t=this;e&&(this._subscribeDeviceIdList=e);var r=this.sdk.loginManager,n=r.isLogin,o=r.accessToken,i=r.appKey;n&&o&&this._subscribeDeviceIdList&&(this.send("ActivePush",{DeviceIds:this._subscribeDeviceIdList,AccessToken:o,AppKey:i}),this.sendWsHeatBeat(),clearInterval(this._heartBeatTimer),this._heartBeatTimer=setInterval((function(){return t.sendWsHeatBeat()}),this.options.heartbeatInterval))},t}(o.default);t.IotWebsocket=l},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(0).__importStar(r(27)),o=function(){function e(e){this.url=e,this.ws=null,this.initWs()}return e.prototype.initWs=function(){n.isMiniProgram?this.ws=wx.connectSocket({url:this.url}):this.ws=new e(this.url)},e.prototype.send=function(e){var t=e.data;n.isMiniProgram?this.ws.send({data:t}):this.ws.send(t)},e.prototype.close=function(e){var t=void 0===e?{}:e,r=t.code,o=t.reason;n.isMiniProgram?this.ws.close({code:r,reason:o}):this.ws.close(r,o)},e.prototype.onOpen=function(e){n.isMiniProgram?this.ws.onOpen(e):this.ws.addEventListener("open",e)},e.prototype.onClose=function(e){n.isMiniProgram?this.ws.onClose(e):this.ws.addEventListener("close",e)},e.prototype.onMessage=function(e){n.isMiniProgram?this.ws.onMessage(e):this.ws.addEventListener("message",e)},e.prototype.onError=function(e){n.isMiniProgram?this.ws.onError(e):this.ws.addEventListener("error",e)},e}();t.WebSocket=o},function(e,t,r){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.isMiniProgram=function(){try{return!!(wx&&wx.request&&wx.connectSocket)}catch(e){return!1}}(),t.isBrowser=function(){try{return"undefined"!=typeof window&&void 0!==window.document}catch(e){return!1}}(),t.isNode=function(){try{return!!e.versions.node}catch(e){return!1}}(),t.isRN=function(){try{return"ReactNative"===navigator.product}catch(e){return!1}}()}).call(this,r(28))},function(e,t){var r,n,o=e.exports={};function i(){throw new Error("setTimeout has not been defined")}function s(){throw new Error("clearTimeout has not been defined")}function c(e){if(r===setTimeout)return setTimeout(e,0);if((r===i||!r)&&setTimeout)return r=setTimeout,setTimeout(e,0);try{return r(e,0)}catch(t){try{return r.call(null,e,0)}catch(t){return r.call(this,e,0)}}}!function(){try{r="function"==typeof setTimeout?setTimeout:i}catch(e){r=i}try{n="function"==typeof clearTimeout?clearTimeout:s}catch(e){n=s}}();var a,u=[],f=!1,l=-1;function d(){f&&a&&(f=!1,a.length?u=a.concat(u):l=-1,u.length&&_())}function _(){if(!f){var e=c(d);f=!0;for(var t=u.length;t;){for(a=u,u=[];++l<t;)a&&a[l].run();l=-1,t=u.length}a=null,f=!1,function(e){if(n===clearTimeout)return clearTimeout(e);if((n===s||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(e);try{n(e)}catch(t){try{return n.call(null,e)}catch(t){return n.call(this,e)}}}(e)}}function p(e,t){this.fun=e,this.array=t}function h(){}o.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];u.push(new p(e,t)),1!==u.length||f||c(_)},p.prototype.run=function(){this.fun.apply(null,this.array)},o.title="browser",o.browser=!0,o.env={},o.argv=[],o.version="",o.versions={},o.on=h,o.addListener=h,o.once=h,o.off=h,o.removeListener=h,o.removeAllListeners=h,o.emit=h,o.prependListener=h,o.prependOnceListener=h,o.listeners=function(e){return[]},o.binding=function(e){throw new Error("process.binding is not supported")},o.cwd=function(){return"/"},o.chdir=function(e){throw new Error("process.chdir is not supported")},o.umask=function(){return 0}},function(e,t){const r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";t.encodeBase64=e=>{if(!e)return!1;let t,n,o,i,s,c,a,u="",f=0;do{t=e.charCodeAt(f++),n=e.charCodeAt(f++),o=e.charCodeAt(f++),i=t>>2,s=(3&t)<<4|n>>4,c=(15&n)<<2|o>>6,a=63&o,isNaN(n)?c=a=64:isNaN(o)&&(a=64),u+=r.charAt(i)+r.charAt(s)+r.charAt(c)+r.charAt(a)}while(f<e.length);return u},t.decodeBase64=e=>{if(!e)return!1;e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");let t,n,o,i,s="",c=0;do{t=r.indexOf(e.charAt(c++)),n=r.indexOf(e.charAt(c++)),o=r.indexOf(e.charAt(c++)),i=r.indexOf(e.charAt(c++)),s+=String.fromCharCode(t<<2|n>>4),64!=o&&(s+=String.fromCharCode((15&n)<<4|o>>2)),64!=i&&(s+=String.fromCharCode((3&o)<<6|i))}while(c<e.length);return s}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(0),o=r(1),i=r(6),s=n.__importDefault(r(7)),c=n.__importDefault(r(3)),a=r(4),u=function(e){var t=new Uint8Array(e),r=String.fromCharCode.apply(null,t);return decodeURIComponent(escape(r))},f=function(e,t,r){return void 0===t&&(t=""),void 0===r&&(r={}),n.__awaiter(void 0,void 0,void 0,(function(){return n.__generator(this,(function(o){switch(o.label){case 0:return wx.hideToast(),[4,i.pify(wx.showModal)(n.__assign({title:e,content:t},r)).then((function(e){return!!e.confirm})).catch((function(){return!1}))];case 1:return[2,o.sent()]}}))}))};t.connectDevice=function(e,t){var r=t.targetWifiInfo,l=t.softApInfo,d=t.familyId,_=void 0===d?"default":d,p=t.udpAddress,h=void 0===p?"192.168.4.1":p,v=t.udpPort,g=void 0===v?8266:v,y=t.waitUdpResponseDuration,E=void 0===y?2e3:y,C=t.udpCommunicationRetryTime,m=void 0===C?5:C,T=t.stepDurationGap,S=void 0===T?3e3:T,w=t.onProgress,I=void 0===w?o.noop:w,b=t.onError,D=void 0===b?o.noop:b,O=t.onComplete,A=void 0===O?o.noop:O,P=t.handleAddDevice;return n.__awaiter(this,void 0,void 0,(function(){var t,d,p,v,y,C,T,w,b,O=this;return n.__generator(this,(function(N){switch(N.label){case 0:s.default(),N.label=1;case 1:return N.trys.push([1,8,,9]),d=function(e){c.default.debug("softap-receive-unhandled-msg",{data:{message:e}})},v=function(e){"string"!=typeof e&&(e=JSON.stringify(e)),t.send({address:h,port:g,message:e})},y=function(e){return n.__awaiter(O,void 0,void 0,(function(){var t=this;return n.__generator(this,(function(r){return[2,new Promise((function(r,i){return n.__awaiter(t,void 0,void 0,(function(){var t,s,u,f;return n.__generator(this,(function(n){switch(n.label){case 0:n.trys.push([0,4,,5]),t=!0,s=0,d=function(e){try{t=!1,r(e)}catch(e){i(e)}},(u=function(){s++,c.default.debug("softap-udp-send-msg",{data:{msg:e,retryCount:s}}),v(e)})(),n.label=1;case 1:return t&&s<=m?[4,o.delay(E)]:[3,3];case 2:return n.sent(),t?(u(),[3,1]):[2];case 3:return i({code:a.ConnectDeviceErrorCode.UDP_NOT_RESPONSED}),[3,5];case 4:return f=n.sent(),i({code:a.ConnectDeviceErrorCode.SEND_UDP_MSG_FAIL,detail:{error:f}}),[3,5];case 5:return[2]}}))}))}))]}))}))},C=function(e){var t=e.SSID,r=e.password;return n.__awaiter(O,void 0,void 0,(function(){return n.__generator(this,(function(e){switch(e.label){case 0:return[4,i.pify(wx.connectWifi)({SSID:t,password:r})];case 1:return e.sent(),[4,i.pify(wx.getConnectedWifi)()];case 2:if(e.sent().wifi.SSID!==t)throw{code:a.ConnectDeviceErrorCode.SSID_NOT_MATCH};return c.default.debug("softap-connect-wifi-success"),[2]}}))}))},T=function(){return n.__awaiter(O,void 0,void 0,(function(){var i,s,l,h,v,g,E=this;return n.__generator(this,(function(m){switch(m.label){case 0:i=!1,m.label=1;case 1:return m.trys.push([1,3,,4]),p(a.ConnectDeviceStepCode.CREATE_UDP_CONNECTION_START),(t=wx.createUDPSocket()).bind(),s=o.genPromise(),l=o.genPromise(),h=o.genPromise(),t.onError((function(e){return s.reject({code:a.ConnectDeviceErrorCode.UDP_ERROR,detail:{errMsg:e}})})),t.onMessage((function(e){try{var t=JSON.parse(u(e.message));c.default.debug("softap-udp-on-message",{data:{message:t}}),2==+t.cmdType&&("Current_Error"===t.deviceReply?h.reject({code:a.ConnectDeviceErrorCode.DEVICE_ERROR,detail:t}):"Previous_Error"===t.deviceReply?c.default.debug("softap-receive-prev-error",{data:{message:t}}):d(t))}catch(e){c.default.debug("softap-udp-parse-message-error",{error:e})}})),v=function(){return n.__awaiter(E,void 0,void 0,(function(){var s,u,l,d,h,v,g,E,m,T,w,I=this;return n.__generator(this,(function(b){switch(b.label){case 0:return s=function(e){return void 0===e&&(e=S),n.__awaiter(I,void 0,void 0,(function(){return n.__generator(this,(function(t){switch(t.label){case 0:return[4,o.delay(e)];case 1:if(t.sent(),i)throw c.default.debug("connection aborted"),null;return[2]}}))}))},u=Date.now(),console.log("step check",u),[4,s()];case 1:return b.sent(),console.log("after step check",Date.now()-u),p(a.ConnectDeviceStepCode.CREATE_UDP_CONNECTION_SUCCESS),p(a.ConnectDeviceStepCode.SEND_TARGET_WIFIINFO_START),[4,y({cmdType:1,ssid:r.SSID,password:r.password})];case 2:if("dataRecived"!==(l=b.sent()).deviceReply)throw{code:a.ConnectDeviceErrorCode.INVALID_UDP_RESPONSE,detail:l};return[4,s(5e3)];case 3:return b.sent(),p(a.ConnectDeviceStepCode.SEND_TARGET_WIFIINFO_SUCCESS,l),p(a.ConnectDeviceStepCode.GET_DEVICE_SIGNATURE_START),[4,y({cmdType:0,timestamp:parseInt(String(Date.now()/1e3))})];case 4:if(d=b.sent(),h=d.mqttState,v=d.wifiState,g=n.__rest(d,["mqttState","wifiState"]),"connected"!==h)throw{code:a.ConnectDeviceErrorCode.DEVICE_CONNECT_MQTT_FAIL};if("connected"!==v)throw{code:a.ConnectDeviceErrorCode.DEVICE_CONNECT_WIFI_FAIL};return[4,s()];case 5:return b.sent(),p(a.ConnectDeviceStepCode.GET_DEVICE_SIGNATURE_SUCCESS,g),t.close(),"function"!=typeof P?[3,7]:[4,P({Signature:g.signature,DeviceTimestamp:g.timestamp,ProductId:g.productId,DeviceName:g.deviceName,ConnId:g.connId})];case 6:return[2,b.sent()];case 7:E=!1,b.label=8;case 8:return b.trys.push([8,10,,12]),p(a.ConnectDeviceStepCode.CONNECT_TARGET_WIFI_START),[4,C(r)];case 9:return b.sent(),[3,12];case 10:return m=b.sent(),[4,f("手机连接路由Wi-Fi失败，请将手机手动切换到能够正常访问的网络环境后继续配网操作","",{confirmText:"继续",confirmColor:"#0052d9",cancelText:"取消",cancelColor:"#ff584c"})];case 11:if(!b.sent())throw{code:a.ConnectDeviceErrorCode.CONNECT_TARGET_WIFI_FAIL,detail:{error:m}};return E=!0,[3,12];case 12:return p(a.ConnectDeviceStepCode.CONNECT_TARGET_WIFI_SUCCESS,{userSkipReconnectWifi:E}),[4,s()];case 13:return b.sent(),T=function(){return n.__awaiter(I,void 0,void 0,(function(){var t;return n.__generator(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,7]),[4,e.requestApi("AppSigBindDeviceInFamily",{Signature:g.signature,DeviceTimestamp:g.timestamp,ProductId:g.productId,DeviceName:g.deviceName,ConnId:g.connId,FamilyId:_||"default"})];case 1:return[2,r.sent()];case 2:return(t=r.sent())?t.errMsg&&/request:fail/.test(t.errMsg)?[4,f("手机切换到该网络环境后依然无法正常上网访问，请继续切换网络重试或取消配网操作","",{confirmText:"重试",confirmColor:"#0052d9",cancelText:"取消",cancelColor:"#ff584c"})]:[3,4]:[3,6];case 3:return r.sent()?[2,T()]:[2,Promise.reject({code:a.ConnectDeviceErrorCode.ADD_DEVICE_FAIL,detail:{error:t}})];case 4:return[4,f(o.getErrorMsg(t),"",{confirmText:"重试",confirmColor:"#0052d9",cancelText:"取消",cancelColor:"#ff584c"})];case 5:return r.sent()?[2,T()]:(t.code=a.ConnectDeviceErrorCode.ADD_DEVICE_FAIL,[2,Promise.reject({code:a.ConnectDeviceErrorCode.ADD_DEVICE_FAIL,detail:{error:t},msg:o.getErrorMsg(t),reqId:t.reqId})]);case 6:return[2,Promise.reject(t)];case 7:return[2]}}))}))},p(a.ConnectDeviceStepCode.ADD_DEVICE_START,{Signature:g.signature,DeviceTimestamp:g.timestamp,ProductId:g.productId,DeviceName:g.deviceName,ConnId:g.connId}),[4,T()];case 14:return w=b.sent(),p(a.ConnectDeviceStepCode.ADD_DEVICE_SUCCESS,w),[2]}}))}))},[4,Promise.race([v(),s.promise,l.promise,h.promise])];case 2:return m.sent(),[3,4];case 3:return g=m.sent(),i=!0,c.default.debug("softap-connect-fail",{error:g}),[2,Promise.reject(g)];case 4:return[2]}}))}))},(p=function(e,t){try{c.default.debug("STEP => "+e+", detail => "+JSON.stringify(t))}catch(e){}I({code:e,msg:a.SoftApStepMsg[e],detail:t})})(a.ConnectDeviceStepCode.CONNECT_DEVICE_START),[4,i.pify(wx.startWifi)()];case 2:if(N.sent(),!l)return[3,6];N.label=3;case 3:return N.trys.push([3,5,,6]),p(a.ConnectDeviceStepCode.CONNECT_SOFTAP_START),[4,C(l)];case 4:return N.sent(),p(a.ConnectDeviceStepCode.CONNECT_SOFTAP_SUCCESS),[3,6];case 5:if((w=N.sent()).code===a.ConnectDeviceErrorCode.SSID_NOT_MATCH)throw{code:a.ConnectDeviceErrorCode.CONNECT_SOFTAP_FAIL};throw w;case 6:return[4,T()];case 7:return N.sent(),p(a.ConnectDeviceStepCode.CONNECT_DEVICE_SUCCESS),A(),[3,9];case 8:return(b=N.sent())&&b.code in a.ConnectDeviceErrorCode&&(b.msg=a.SoftApErrorMsg[b.code]),D(b),[3,9];case 9:return[2]}}))}))}}])}));