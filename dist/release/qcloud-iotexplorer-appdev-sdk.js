!function(e,t){if("object"==typeof exports&&"object"==typeof module)module.exports=t();else if("function"==typeof define&&define.amd)define([],t);else{var r=t();for(var n in r)("object"==typeof exports?exports:e)[n]=r[n]}}(window,(function(){return function(e){var t={};function r(n){if(t[n])return t[n].exports;var o=t[n]={i:n,l:!1,exports:{}};return e[n].call(o.exports,o,o.exports,r),o.l=!0,o.exports}return r.m=e,r.c=t,r.d=function(e,t,n){r.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:n})},r.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},r.t=function(e,t){if(1&t&&(e=r(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(r.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var o in e)r.d(n,o,function(t){return e[t]}.bind(null,o));return n},r.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return r.d(t,"a",t),t},r.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},r.p="",r(r.s=11)}([function(e,t,r){"use strict";r.r(t),r.d(t,"__extends",(function(){return o})),r.d(t,"__assign",(function(){return i})),r.d(t,"__rest",(function(){return s})),r.d(t,"__decorate",(function(){return a})),r.d(t,"__param",(function(){return u})),r.d(t,"__metadata",(function(){return c})),r.d(t,"__awaiter",(function(){return f})),r.d(t,"__generator",(function(){return d})),r.d(t,"__exportStar",(function(){return l})),r.d(t,"__values",(function(){return p})),r.d(t,"__read",(function(){return h})),r.d(t,"__spread",(function(){return _})),r.d(t,"__spreadArrays",(function(){return v})),r.d(t,"__await",(function(){return g})),r.d(t,"__asyncGenerator",(function(){return y})),r.d(t,"__asyncDelegator",(function(){return m})),r.d(t,"__asyncValues",(function(){return w})),r.d(t,"__makeTemplateObject",(function(){return b})),r.d(t,"__importStar",(function(){return E})),r.d(t,"__importDefault",(function(){return I}));var n=function(e,t){return(n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)t.hasOwnProperty(r)&&(e[r]=t[r])})(e,t)};function o(e,t){function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)}var i=function(){return(i=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e}).apply(this,arguments)};function s(e,t){var r={};for(var n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.indexOf(n)<0&&(r[n]=e[n]);if(null!=e&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(n=Object.getOwnPropertySymbols(e);o<n.length;o++)t.indexOf(n[o])<0&&Object.prototype.propertyIsEnumerable.call(e,n[o])&&(r[n[o]]=e[n[o]])}return r}function a(e,t,r,n){var o,i=arguments.length,s=i<3?t:null===n?n=Object.getOwnPropertyDescriptor(t,r):n;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)s=Reflect.decorate(e,t,r,n);else for(var a=e.length-1;a>=0;a--)(o=e[a])&&(s=(i<3?o(s):i>3?o(t,r,s):o(t,r))||s);return i>3&&s&&Object.defineProperty(t,r,s),s}function u(e,t){return function(r,n){t(r,n,e)}}function c(e,t){if("object"==typeof Reflect&&"function"==typeof Reflect.metadata)return Reflect.metadata(e,t)}function f(e,t,r,n){return new(r||(r=Promise))((function(o,i){function s(e){try{u(n.next(e))}catch(e){i(e)}}function a(e){try{u(n.throw(e))}catch(e){i(e)}}function u(e){e.done?o(e.value):new r((function(t){t(e.value)})).then(s,a)}u((n=n.apply(e,t||[])).next())}))}function d(e,t){var r,n,o,i,s={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:a(0),throw:a(1),return:a(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function a(i){return function(a){return function(i){if(r)throw new TypeError("Generator is already executing.");for(;s;)try{if(r=1,n&&(o=2&i[0]?n.return:i[0]?n.throw||((o=n.return)&&o.call(n),0):n.next)&&!(o=o.call(n,i[1])).done)return o;switch(n=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return s.label++,{value:i[1],done:!1};case 5:s.label++,n=i[1],i=[0];continue;case 7:i=s.ops.pop(),s.trys.pop();continue;default:if(!(o=(o=s.trys).length>0&&o[o.length-1])&&(6===i[0]||2===i[0])){s=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){s.label=i[1];break}if(6===i[0]&&s.label<o[1]){s.label=o[1],o=i;break}if(o&&s.label<o[2]){s.label=o[2],s.ops.push(i);break}o[2]&&s.ops.pop(),s.trys.pop();continue}i=t.call(e,s)}catch(e){i=[6,e],n=0}finally{r=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,a])}}}function l(e,t){for(var r in e)t.hasOwnProperty(r)||(t[r]=e[r])}function p(e){var t="function"==typeof Symbol&&e[Symbol.iterator],r=0;return t?t.call(e):{next:function(){return e&&r>=e.length&&(e=void 0),{value:e&&e[r++],done:!e}}}}function h(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,i=r.call(e),s=[];try{for(;(void 0===t||t-- >0)&&!(n=i.next()).done;)s.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=i.return)&&r.call(i)}finally{if(o)throw o.error}}return s}function _(){for(var e=[],t=0;t<arguments.length;t++)e=e.concat(h(arguments[t]));return e}function v(){for(var e=0,t=0,r=arguments.length;t<r;t++)e+=arguments[t].length;var n=Array(e),o=0;for(t=0;t<r;t++)for(var i=arguments[t],s=0,a=i.length;s<a;s++,o++)n[o]=i[s];return n}function g(e){return this instanceof g?(this.v=e,this):new g(e)}function y(e,t,r){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var n,o=r.apply(e,t||[]),i=[];return n={},s("next"),s("throw"),s("return"),n[Symbol.asyncIterator]=function(){return this},n;function s(e){o[e]&&(n[e]=function(t){return new Promise((function(r,n){i.push([e,t,r,n])>1||a(e,t)}))})}function a(e,t){try{(r=o[e](t)).value instanceof g?Promise.resolve(r.value.v).then(u,c):f(i[0][2],r)}catch(e){f(i[0][3],e)}var r}function u(e){a("next",e)}function c(e){a("throw",e)}function f(e,t){e(t),i.shift(),i.length&&a(i[0][0],i[0][1])}}function m(e){var t,r;return t={},n("next"),n("throw",(function(e){throw e})),n("return"),t[Symbol.iterator]=function(){return this},t;function n(n,o){t[n]=e[n]?function(t){return(r=!r)?{value:g(e[n](t)),done:"return"===n}:o?o(t):t}:o}}function w(e){if(!Symbol.asyncIterator)throw new TypeError("Symbol.asyncIterator is not defined.");var t,r=e[Symbol.asyncIterator];return r?r.call(e):(e=p(e),t={},n("next"),n("throw"),n("return"),t[Symbol.asyncIterator]=function(){return this},t);function n(r){t[r]=e[r]&&function(t){return new Promise((function(n,o){(function(e,t,r,n){Promise.resolve(n).then((function(t){e({value:t,done:r})}),t)})(n,o,(t=e[r](t)).done,t.value)}))}}}function b(e,t){return Object.defineProperty?Object.defineProperty(e,"raw",{value:t}):e.raw=t,e}function E(e){if(e&&e.__esModule)return e;var t={};if(null!=e)for(var r in e)Object.hasOwnProperty.call(e,r)&&(t[r]=e[r]);return t.default=e,t}function I(e){return e&&e.__esModule?e:{default:e}}},function(e,t,r){"use strict";var n,o,i,s=r(17),a="0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ_-";function u(){i=!1}function c(e){if(e){if(e!==n){if(e.length!==a.length)throw new Error("Custom alphabet for shortid must be "+a.length+" unique characters. You submitted "+e.length+" characters: "+e);var t=e.split("").filter((function(e,t,r){return t!==r.lastIndexOf(e)}));if(t.length)throw new Error("Custom alphabet for shortid must be "+a.length+" unique characters. These characters were not unique: "+t.join(", "));n=e,u()}}else n!==a&&(n=a,u())}function f(){return i||(i=function(){n||c(a);for(var e,t=n.split(""),r=[],o=s.nextValue();t.length>0;)o=s.nextValue(),e=Math.floor(o*t.length),r.push(t.splice(e,1)[0]);return r.join("")}())}e.exports={get:function(){return n||a},characters:function(e){return c(e),n},seed:function(e){s.seed(e),o!==e&&(u(),o=e)},lookup:function(e){return f()[e]},shuffled:f}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(0).__importDefault(r(10));t.appendParams=function(e,t){void 0===t&&(t={});var r=[];return Object.keys(t).forEach((function(e){var o=t[e];void 0!==o&&(n.default(o)&&(o=JSON.stringify(o)),r.push(e+"="+encodeURIComponent(o)))})),r.length?(e.indexOf("?")>-1?e+"&":e+"?")+r.join("&"):e},t.delay=function(e){return new Promise((function(t){return setTimeout(t,e)}))},t.genPromise=function(){var e,t;return{promise:new Promise((function(r,n){e=r,t=n})),resolve:e,reject:t}},t.noop=function(){},t.getErrorMsg=function(e){if(e){var t="";return"string"==typeof e?e:(t=e.msg||e.Message||e.message||e.errMsg||"连接服务器失败，请稍后再试",e.reqId&&(t+="("+e.reqId+")"),t||(t="连接服务器失败，请稍后再试"),t)}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(0);t.LogLevel={log:"log",debug:"log",info:"info",warn:"warn",error:"error"};var o={debug:!1},i=function(e){for(var r=[],i=1;i<arguments.length;i++)r[i-1]=arguments[i];e in t.LogLevel||(e=t.LogLevel.debug),o.debug&&console[t.LogLevel[e]].apply(console,n.__spread(r))};t.default={config:function(e){return void 0===e&&(e={}),Object.assign(o,e)},info:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return i.apply(void 0,n.__spread(["info"],e))},debug:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return i.apply(void 0,n.__spread(["debug"],e))},warn:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return i.apply(void 0,n.__spread(["warn"],e))},error:function(){for(var e=[],t=0;t<arguments.length;t++)e[t]=arguments[t];return i.apply(void 0,n.__spread(["error"],e))}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=Object.defineProperty,o=Object.create,i=Object.prototype.hasOwnProperty,s={configurable:!0,enumerable:!1,writable:!0,value:null};function a(e){if("function"!=typeof e)throw new TypeError(e+" is not a function");return e}var u=function(){function e(){}return e.prototype.on=function(e,t){var r;return a(t),i.call(this,"__ee__")?r=this.__ee__:(r=s.value=o(null),n(this,"__ee__",s),s.value=null),r[e]?r[e].push(t):r[e]=[t],this},e.prototype.once=function(e,t){var r,n=this;return a(t),this.on.call(this,e,r=function(){for(var o=[],i=0;i<arguments.length;i++)o[i]=arguments[i];n.off.call(void 0,e,r),t.apply(n,o)}),this},e.prototype.off=function(e,t){if(!i.call(this,"__ee__"))return this;var r=this.__ee__;if(!r[e])return this;if(t){var n=r[e]||[],o=n.indexOf(t);o>-1&&n.splice(o,1)}else r[e].length=0;return this},e.prototype.emit=function(e){for(var t=this,r=[],n=1;n<arguments.length;n++)r[n-1]=arguments[n];if(i.call(this,"__ee__")){var o=this.__ee__[e];o&&o.length&&o.forEach((function(e){return e.apply(t,r)}))}},e}();t.default=u},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(0);t.pify=function(e,t){return void 0===t&&(t=wx),function(r){for(var o=[],i=1;i<arguments.length;i++)o[i-1]=arguments[i];return new Promise((function(i,s){e?e.call.apply(e,n.__spread([t,n.__assign(n.__assign({},r),{success:i,fail:s})],o)):wx.showModal({title:"提示",content:"当前微信版本过低，无法使用该功能，请升级到最新微信版本后重试",complete:function(){return s()},confirmColor:"#006eff",showCancel:!1})}))}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(0);t.normalizeError=function(e){return e&&(e.errMsg&&["auth deny","scope unauthorized"].some((function(t){return String(e.errMsg).indexOf(t)>-1}))?Object.assign(e,{code:"UserNeedAuth",msg:"尚未开启微信基本信息授权，请授权后使用"}):t.isVerifyLoginError(e)&&(e=t.genVerifyLoginFailError(e))),e},t.genVerifyLoginFailError=function(e){e||(e={});e.code,e.msg;var t=e.reqId,r=n.__rest(e,["code","msg","reqId"]);return n.__assign({code:"VERIFY_LOGIN_FAILED",msg:"登录态验证失败，请重新登录",reqId:t},r)},t.isVerifyLoginError=function(e){return e&&(e.code||"").indexOf("InvalidAccessToken")>-1},t.handleVerifyLoginError=function(e){if(t.isVerifyLoginError(e))throw t.genVerifyLoginFailError(e)}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(0);n.__exportStar(r(8),t),n.__exportStar(r(16),t)},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(0),o=n.__importDefault(r(15)),i=r(5),s=0;t.request=function(e){return n.__awaiter(void 0,void 0,void 0,(function(){var t,r=e.url,a=e.data,u=e.header,c=void 0===u?{}:u,f=e.method,d=void 0===f?"get":f,l=e.dataType,p=e.responseType,h=n.__rest(e,["url","data","header","method","dataType","responseType"]);return n.__generator(this,(function(e){switch(e.label){case 0:e.trys.push([0,5,6,7]),e.label=1;case 1:return s>=10?[4,o.default.startBlocking()]:[3,3];case 2:return e.sent(),[3,1];case 3:return s++,[4,i.pify(wx.request)(n.__assign({url:r,data:a,header:c,method:d,dataType:l,responseType:p},h))];case 4:return[2,e.sent()];case 5:return t=e.sent(),[2,Promise.reject(t)];case 6:return s--,o.default.resolveFirstBlock(),[7];case 7:return[2]}}))}))}},function(e,t,r){"use strict";var n=r(1),o=r(18),i=r(22),s=r(23)||0;function a(){return o(s)}e.exports=a,e.exports.generate=a,e.exports.seed=function(t){return n.seed(t),e.exports},e.exports.worker=function(t){return s=t,e.exports},e.exports.characters=function(e){return void 0!==e&&n.characters(e),n.shuffled()},e.exports.isValid=i},function(e,t,r){"use strict";function n(e){return!0==(null!=(t=e)&&"object"==typeof t&&!1===Array.isArray(t))&&"[object Object]"===Object.prototype.toString.call(e);var t}function o(e){var t,r;return!1!==n(e)&&("function"==typeof(t=e.constructor)&&(!1!==n(r=t.prototype)&&!1!==r.hasOwnProperty("isPrototypeOf")))}r.r(t),r.d(t,"default",(function(){return o}))},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(0);r(12),n.__exportStar(r(13),t)},function(e,t){},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(0),o=r(14),i=n.__importDefault(r(4)),s=r(25),a=n.__importDefault(r(3)),u=r(29),c=r(30),f=r(2),d=r(7),l=r(6),p=r(31),h=function(e){function t(t){var r=t.getAccessToken,i=void 0===r?f.noop:r,u=t.appKey,d=void 0===u?"":u,l=t.apiPlatform,p=void 0===l?"":l,h=t.debug,_=void 0!==h&&h,v=t.wsConfig,g=void 0===v?{}:v,y=g.autoReconnect,m=void 0===y||y,w=g.disconnectWhenAppHide,b=void 0===w||w,E=g.connectWhenAppShow,I=void 0===E||E,P=n.__rest(g,["autoReconnect","disconnectWhenAppHide","connectWhenAppShow"]),S=e.call(this)||this;return S.isManuallyClose=!1,S._defaultFamilyIdPromise=null,a.default.config({debug:_}),S.ws=new s.IotWebsocket(S,n.__assign(n.__assign({},P),{apiPlatform:p})),S.loginManager=new o.LoginManager(S,{getAccessToken:i,appKey:d}),S._apiPlatform=p,S.ws.on("error",(function(e){a.default.debug("websocket error",e),S.emit(c.EventTypes.wsError,e),m&&S._reconnectWs()})),S.ws.on("close",(function(e){var t=void 0===e?{}:e,r=t.code,n=t.reason;a.default.debug("websocket close",{code:r,reason:n}),S.emit(c.EventTypes.wsClose,{code:r,reason:n}),m&&S._onWebsocketClose()})),S.ws.on("push",(function(e){return S._handlePushEvent(e)})),wx.onAppHide((function(){b&&(S.isManuallyClose=!0,S.ws.disconnect())})),wx.onAppShow((function(){I&&S.isLogin&&S.ws.connect()})),S}return n.__extends(t,e),Object.defineProperty(t.prototype,"userInfo",{get:function(){return this.loginManager.userInfo},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"isLogin",{get:function(){return this.loginManager.isLogin},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"userId",{get:function(){return this.loginManager.userId},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"nickName",{get:function(){return this.loginManager.nickName},enumerable:!0,configurable:!0}),t.prototype.init=function(e){return void 0===e&&(e=!1),n.__awaiter(this,void 0,void 0,(function(){var t=this;return n.__generator(this,(function(r){return e&&(this._initPromise=null),[2,this._initPromise||(this._initPromise=new Promise((function(e,r){return n.__awaiter(t,void 0,void 0,(function(){var t;return n.__generator(this,(function(n){switch(n.label){case 0:return n.trys.push([0,3,,4]),[4,this.loginManager.login()];case 1:return n.sent(),[4,this.ws.connect()];case 2:return n.sent(),e(),[3,4];case 3:return t=n.sent(),r(l.normalizeError(t)),this._initPromise=null,[3,4];case 4:return[2]}}))}))})))]}))}))},t.prototype.getDefaultFamilyId=function(){var e=this;return this._defaultFamilyIdPromise||(this._defaultFamilyIdPromise=new Promise((function(t,r){return n.__awaiter(e,void 0,void 0,(function(){var e,o,i,s;return n.__generator(this,(function(n){switch(n.label){case 0:return n.trys.push([0,4,,5]),[4,this.requestApi("AppGetFamilyList",{Offset:0,Limit:100})];case 1:return e=n.sent(),o=e.FamilyList,e.Total?[3,3]:[4,this.requestApi("AppCreateFamily",{Name:this.loginManager.nickName})];case 2:return i=n.sent().Data.FamilyId,[2,t(i)];case 3:return t(o[0].FamilyId),[3,5];case 4:return s=n.sent(),r(s),this._defaultFamilyIdPromise=null,[3,5];case 5:return[2]}}))}))})))},t.prototype.sendWebsocketMessage=function(e,t,r){void 0===t&&(t={});var o=(void 0===r?{}:r).reqId;return n.__awaiter(this,void 0,void 0,(function(){return n.__generator(this,(function(r){switch(r.label){case 0:return[4,this.init()];case 1:return r.sent(),[2,this.ws.send(e,t,{reqId:o})]}}))}))},t.prototype.connectWebsocket=function(){return n.__awaiter(this,void 0,void 0,(function(){return n.__generator(this,(function(e){switch(e.label){case 0:return[4,this.init()];case 1:return e.sent(),[4,this.ws.connect()];case 2:return e.sent(),[2]}}))}))},t.prototype.disconnectWebsocket=function(){this.ws.disconnect()},t.prototype.subscribeDevices=function(e){return void 0===e&&(e=[]),n.__awaiter(this,void 0,void 0,(function(){return n.__generator(this,(function(t){return this.ws.subscribe(e.map((function(e){return"string"==typeof e?e:e&&e.DeviceId?e.DeviceId:void 0})).filter(Boolean)),[2]}))}))},t.prototype.requestApi=function(e,t,r){void 0===t&&(t={}),void 0===r&&(r={});var o=r.doNotRetry,i=void 0!==o&&o,s=r.needLogin,u=void 0===s||s,c=n.__rest(r,["doNotRetry","needLogin"]);return n.__awaiter(this,void 0,void 0,(function(){var r,o,s,f,p,h,_;return n.__generator(this,(function(v){switch(v.label){case 0:return v.trys.push([0,6,,13]),u?[4,this.loginManager.checkLogin()]:[3,2];case 1:v.sent(),v.label=2;case 2:return r=this.loginManager,o=r.accessToken,s=r.userId,t&&"default"===t.FamilyId?(f=t,[4,this.getDefaultFamilyId()]):[3,4];case 3:f.FamilyId=v.sent(),v.label=4;case 4:return p=n.__assign({uin:s},t),o&&(p.AccessToken=o),this._apiPlatform&&(p.Platform=this._apiPlatform),[4,d.requestTokenApi(e,p,c)];case 5:return[2,v.sent()];case 6:if(h=v.sent(),a.default.debug("requestApi fail",h),!l.isVerifyLoginError(h))return[3,12];if(i)return[3,11];v.label=7;case 7:return v.trys.push([7,9,,10]),[4,this.loginManager.reLogin()];case 8:return v.sent(),[3,10];case 9:return _=v.sent(),a.default.error("reLogin fail",_),[2,Promise.reject(l.genVerifyLoginFailError(h))];case 10:return[2,this.requestApi(e,t,n.__assign({doNotRetry:!0},c))];case 11:return[2,Promise.reject(l.genVerifyLoginFailError(h))];case 12:return[2,Promise.reject(l.normalizeError(h))];case 13:return[2]}}))}))},t.prototype.connectSoftAp=function(e){return p.connectSoftAp(this,e)},t.prototype._handlePushEvent=function(e){e||(e={}),this.emit(c.EventTypes.wsPush,e);var t=e.action,r=e.params;r||(r={}),a.default.debug("actions updateDeviceDataByPush",e);var n=r.DeviceId,o=r.Type,i=r.SubType,s=r.Payload,f=r.Time,d=new Date(f).getTime();switch(t){case"DeviceChange":switch(o){case"Property":case"Shadow":case"Template":switch(i){case"Report":var l={};try{var p=JSON.parse(u.decodeBase64(s));if(a.default.debug("actions updateDeviceData payload",p),p){var h=p.type,_=p.state,v=p.method,g=p.params;if(h&&"update"===h&&_&&_.reported&&(v="report",g=_.reported),g||(g={}),"report"===v)for(var y in g)l[y]={Value:g[y],lastUpdate:d}}}catch(e){a.default.error("handle report event error",e)}this.emit(c.EventTypes.wsReport,{deviceId:n,deviceData:l});break;case"Push":l={};try{if(s){h=s.type,p=s.payload,v=s.method,g=s.params;if(h&&"delta"===h&&p&&p.state&&(v="control",g=p.state),"control"===v&&g){for(var y in g)l[y]={Value:g[y],LastUpdate:d};this.emit(c.EventTypes.wsControl,{deviceId:n,deviceData:l})}}}catch(e){a.default.error(e)}}break;case"StatusChange":var m="Online"===i?1:0;this.emit(c.EventTypes.wsStatusChange,{deviceId:n,deviceStatus:m})}}},t.prototype._onWebsocketClose=function(){if(!this.isManuallyClose)return this._reconnectWs();this.isManuallyClose=!1},t.prototype._reconnectWs=function(){return n.__awaiter(this,void 0,void 0,(function(){var e;return n.__generator(this,(function(t){switch(t.label){case 0:return t.trys.push([0,3,,4]),a.default.debug("websocket reconnecting in 2 seconds"),[4,f.delay(2e3)];case 1:return t.sent(),[4,this.ws.connect()];case 2:return t.sent(),[3,4];case 3:return e=t.sent(),a.default.error("error when reconnect ws",e),[2,Promise.reject(e)];case 4:return[2]}}))}))},t.EventTypes=c.EventTypes,t}(i.default);t.QcloudIotExplorerAppDevSdk=h},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(0),o=n.__importDefault(r(4)),i=r(7),s=n.__importDefault(r(24)),a=r(6),u=n.__importDefault(r(3)),c="__qcloud-iotexplorer-appdev-sdk-accessToken",f=function(e){function t(t,r){var n=r.getAccessToken,o=r.appKey,i=e.call(this)||this;return i.accessToken="",i.appKey="",i.isLogin=!1,i.userInfo=null,i.sdk=t,i.getAccessToken=n,i.appKey=o,i}return n.__extends(t,e),t.prototype.login=function(){return n.__awaiter(this,void 0,void 0,(function(){var e,t,r,o,f;return n.__generator(this,(function(n){switch(n.label){case 0:e=!1,n.label=1;case 1:return n.trys.push([1,7,,10]),[4,s.default.getItem(c)];case 2:return(t=n.sent())?[3,4]:[4,this.getAccessToken()];case 3:return r=n.sent().Token,t=r,[3,5];case 4:e=!0,n.label=5;case 5:return[4,i.requestTokenApi("AppGetUser",{AccessToken:t})];case 6:return o=n.sent().Data,s.default.setItem(c,t),this.accessToken=t,this.userInfo=o,this.isLogin=!0,[3,10];case 7:return f=n.sent(),a.isVerifyLoginError(f)?[4,this.logout()]:[3,9];case 8:if(n.sent(),e)return u.default.debug("Cached Token expired, retrying..."),[2,this.login()];n.label=9;case 9:return[2,Promise.reject(f)];case 10:return[2]}}))}))},Object.defineProperty(t.prototype,"userId",{get:function(){return this.userInfo?this.userInfo.UserID:""},enumerable:!0,configurable:!0}),Object.defineProperty(t.prototype,"nickName",{get:function(){return this.userInfo?this.userInfo.NickName:""},enumerable:!0,configurable:!0}),t.prototype.checkLogin=function(){if(!this.isLogin)throw a.genVerifyLoginFailError()},t.prototype.logout=function(){return n.__awaiter(this,void 0,void 0,(function(){return n.__generator(this,(function(e){switch(e.label){case 0:return[4,s.default.removeItem(c)];case 1:return e.sent(),this.accessToken="",this.isLogin=!1,[2]}}))}))},t.prototype.reLogin=function(){return n.__awaiter(this,void 0,void 0,(function(){return n.__generator(this,(function(e){switch(e.label){case 0:return[4,this.logout()];case 1:return e.sent(),[4,this.login()];case 2:return e.sent(),[2]}}))}))},t}(o.default);t.LoginManager=f},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=[];t.default={resolveFirstBlock:function(){n.length&&(n[0].resolve(),n.shift())},startBlocking:function(){var e,t=new Promise((function(t){e=t}));return n.push({promise:t,resolve:e}),t}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(0),o=n.__importDefault(r(9)),i=r(2),s=r(8);t.requestTokenApi=function(e,t,r){return void 0===t&&(t={}),void 0===r&&(r={}),n.__awaiter(void 0,void 0,void 0,(function(){var a,u,c,f,d,l,p,h,_,v=t.uin,g=t.AccessToken,y=n.__rest(t,["uin","AccessToken"]),m=r.method,w=void 0===m?"POST":m,b=n.__rest(r,["method"]);return n.__generator(this,(function(t){switch(t.label){case 0:return u=o.default(),c={uin:v,cmd:e},y=Object.assign({},y,{Action:e,RequestId:u,AccessToken:g}),f=i.appendParams(b.url||"https://iot.cloud.tencent.com/api/exploreropen/tokenapi",c),a=n.__assign({url:f,data:y,method:w},b),[4,s.request(a)];case 1:if(d=t.sent().data,l=d.code,p=d.msg,h=d.data,_=void 0===h?{}:h,l){if(_){if(_.Error)throw{code:_.Error.Code,msg:_.Error.Message,reqId:u};throw{code:l,msg:p,reqId:u}}throw{code:l,msg:p}}return[2,_]}}))}))}},function(e,t,r){"use strict";var n=1;e.exports={nextValue:function(){return(n=(9301*n+49297)%233280)/233280},seed:function(e){n=e}}},function(e,t,r){"use strict";var n,o,i=r(19),s=(r(1),1459707606518),a=6;e.exports=function(e){var t="",r=Math.floor(.001*(Date.now()-s));return r===o?n++:(n=0,o=r),t+=i(a),t+=i(e),n>0&&(t+=i(n)),t+=i(r)}},function(e,t,r){"use strict";var n=r(1),o=r(20),i=r(21);e.exports=function(e){for(var t,r=0,s="";!t;)s+=i(o,n.get(),1),t=e<Math.pow(16,r+1),r++;return s}},function(e,t,r){"use strict";var n,o="object"==typeof window&&(window.crypto||window.msCrypto);n=o&&o.getRandomValues?function(e){return o.getRandomValues(new Uint8Array(e))}:function(e){for(var t=[],r=0;r<e;r++)t.push(Math.floor(256*Math.random()));return t},e.exports=n},function(e,t){e.exports=function(e,t,r){for(var n=(2<<Math.log(t.length-1)/Math.LN2)-1,o=Math.ceil(1.6*n*r/t.length),i="";;)for(var s=e(o),a=0;a<o;a++){var u=s[a]&n;if(t[u]&&(i+=t[u]).length===r)return i}}},function(e,t,r){"use strict";var n=r(1);e.exports=function(e){return!(!e||"string"!=typeof e||e.length<6)&&!new RegExp("[^"+n.get().replace(/[|\\{}()[\]^$+*?.-]/g,"\\$&")+"]").test(e)}},function(e,t,r){"use strict";e.exports=0},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(0),o=r(5);t.default={getItem:function(e){return n.__awaiter(this,void 0,void 0,(function(){return n.__generator(this,(function(t){switch(t.label){case 0:return t.trys.push([0,2,,3]),[4,o.pify(wx.getStorage)({key:e})];case 1:return[2,t.sent().data];case 2:return t.sent(),[2,null];case 3:return[2]}}))}))},setItem:function(e,t){return n.__awaiter(this,void 0,void 0,(function(){var r;return n.__generator(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,3]),[4,o.pify(wx.setStorage)({key:e,data:t})];case 1:return n.sent(),[3,3];case 2:return r=n.sent(),console.error("setStorage error",r),[3,3];case 3:return[2]}}))}))},removeItem:function(e){return n.__awaiter(this,void 0,void 0,(function(){var t;return n.__generator(this,(function(r){switch(r.label){case 0:return r.trys.push([0,2,,3]),[4,o.pify(wx.removeStorage)({key:e})];case 1:return r.sent(),[3,3];case 2:return t=r.sent(),console.error("removeStorage error",t),[3,3];case 3:return[2]}}))}))}}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(0),o=n.__importDefault(r(4)),i=n.__importDefault(r(9)),s=r(2),a=r(26),u=n.__importDefault(r(3)),c=n.__importDefault(r(10)),f=r(6),d={url:"wss://iot.cloud.tencent.com/ws/explorer",heartbeatInterval:6e4},l=function(e){function t(t,r){var n=e.call(this)||this;return n.sdk=t,n.requestHandlerMap=new Map,n.options=Object.assign({},d,r),n._connected=!1,n._subscribeDeviceIdList=[],n._heartBeatTimer=null,n}return n.__extends(t,e),t.prototype.isConnected=function(){return!!this._connected},t.prototype.doConnectWs=function(){return n.__awaiter(this,void 0,void 0,(function(){var e=this;return n.__generator(this,(function(t){return[2,this._doConnectWsPromise||(this._doConnectWsPromise=new Promise((function(t,r){return n.__awaiter(e,void 0,void 0,(function(){var e,o,i=this;return n.__generator(this,(function(c){e=function(e){r(e),i.emit("error",e),i.disconnect()};try{o=this.options.url,this.ws=new a.WebSocket(s.appendParams(o,{uin:this.sdk.loginManager.userId})),this.ws.onOpen((function(){u.default.debug("websocket connected"),i._connected=!0,i.emit("connect"),t()})),this.ws.onError(e),this.ws.onMessage((function(e){var t=e.data;i.emit("message",t);try{t=JSON.parse(t)}catch(e){return void u.default.warn("onMessage parse event.data error: "+t)}t.push?i.emit("push",t):void 0!==t.reqId&&i.requestHandlerMap.has(t.reqId)&&i.requestHandlerMap.get(t.reqId)(null,t)})),this.ws.onClose((function(e){return n.__awaiter(i,void 0,void 0,(function(){return n.__generator(this,(function(t){return u.default.debug("websocket closed"),this.disconnect(),this.emit("close",e),[2]}))}))}))}catch(t){e(t)}return[2]}))}))})))]}))}))},t.prototype.connect=function(){return n.__awaiter(this,void 0,void 0,(function(){return n.__generator(this,(function(e){switch(e.label){case 0:return[4,this.sdk.loginManager.checkLogin()];case 1:return e.sent(),this.isConnected()?[3,3]:[4,this.doConnectWs()];case 2:e.sent(),e.label=3;case 3:return[2,this.activePush()]}}))}))},t.prototype.subscribe=function(e){return this.activePush(e)},t.prototype.disconnect=function(){if(this.ws){this.ws.close({}),this._connected=!1,this._doConnectWsPromise=null,this.ws=null,clearInterval(this._heartBeatTimer),this._heartBeatTimer=null}},t.prototype.send=function(e,t,r){void 0===t&&(t={});var o=(void 0===r?{}:r).reqId;return n.__awaiter(this,void 0,void 0,(function(){var r=this;return n.__generator(this,(function(n){switch(n.label){case 0:if(o||(o=i.default()),!this.ws)return[3,5];this.ws.send({data:JSON.stringify({action:e,reqId:o,params:t})}),n.label=1;case 1:return n.trys.push([1,,3,4]),[4,Promise.race([new Promise((function(e,t){r.requestHandlerMap.set(o,(function(r,n){if(!r)return n.data||!n.error&&!n.error_message?e(n.data):t({code:n.error,msg:n.error_message});t(r)}))})),new Promise((function(e,t){setTimeout((function(){t({code:"TIMEOUT"})}),2e4)}))])];case 2:return[2,n.sent()];case 3:return this.requestHandlerMap.delete(o),[7];case 4:return[3,6];case 5:u.default.warn("Try send ws message but no ws instance",e,t),n.label=6;case 6:return[2]}}))}))},t.prototype.callYunApi=function(e,t,r){void 0===t&&(t={});var o=(void 0===r?{}:r).doNotRetry;return n.__awaiter(this,void 0,void 0,(function(){var r,s,a,d,l,p,h,_,v,g,y,m;return n.__generator(this,(function(n){switch(n.label){case 0:r=i.default(),s=this.sdk.loginManager,a=s.accessToken,d=s.appKey,(t=Object.assign({},t,{RequestId:r})).AccessToken=a,l={Action:e,ActionParams:t},this.options.apiPlatform?l.Platform=this.options.apiPlatform:l.AppKey=d,u.default.debug("yunapi start("+r+") => ",l),n.label=1;case 1:return n.trys.push([1,3,,11]),[4,this.send("YunApi",l,{reqId:r})];case 2:if(!(p=n.sent()))throw u.default.error("empty response",l),{msg:"连接服务器失败，请稍后重试"};if(!(h=p.Response))throw u.default.error("empty response",l,h),{msg:"连接服务器失败，请稍后重试"};if(_=h.Error,v=h.error,g=h.error_message,_)throw{code:_.Code,msg:_.Message};if(v)throw{code:v,msg:g};return u.default.debug("yunapi success("+r+") => ",l,h),[2,h];case 3:if(y=n.sent(),u.default.error("yunapi fail("+r+") => ",y),!f.isVerifyLoginError(y))return[3,10];if(o)return[3,8];n.label=4;case 4:return n.trys.push([4,6,,7]),[4,this.sdk.loginManager.reLogin()];case 5:return n.sent(),[3,7];case 6:return m=n.sent(),u.default.error("reLogin fail",m),[2,Promise.reject(f.genVerifyLoginFailError(y))];case 7:return[2,this.callYunApi(e,t,{doNotRetry:!0})];case 8:return[4,this.sdk.loginManager.logout()];case 9:return n.sent(),[2,f.genVerifyLoginFailError(y)];case 10:return c.default(y)&&(y.reqId=r),[2,Promise.reject(y)];case 11:return[2]}}))}))},t.prototype.sendWsHeatBeat=function(){if(this._subscribeDeviceIdList&&this._subscribeDeviceIdList.length)return this.callYunApi("AppDeviceTraceHeartBeat",{DeviceIds:this._subscribeDeviceIdList})},t.prototype.activePush=function(e){var t=this;e&&(this._subscribeDeviceIdList=e);var r=this.sdk.loginManager,n=r.isLogin,o=r.accessToken,i=r.appKey;n&&o&&this._subscribeDeviceIdList&&(this.send("ActivePush",{DeviceIds:this._subscribeDeviceIdList,AccessToken:o,AppKey:i}),this.sendWsHeatBeat(),clearInterval(this._heartBeatTimer),this._heartBeatTimer=setInterval((function(){return t.sendWsHeatBeat()}),this.options.heartbeatInterval))},t}(o.default);t.IotWebsocket=l},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(0).__importStar(r(27)),o=function(){function e(e){this.url=e,this.ws=null,this.initWs()}return e.prototype.initWs=function(){n.isMiniProgram?this.ws=wx.connectSocket({url:this.url}):this.ws=new e(this.url)},e.prototype.send=function(e){var t=e.data;n.isMiniProgram?this.ws.send({data:t}):this.ws.send(t)},e.prototype.close=function(e){var t=void 0===e?{}:e,r=t.code,o=t.reason;n.isMiniProgram?this.ws.close({code:r,reason:o}):this.ws.close(r,o)},e.prototype.onOpen=function(e){n.isMiniProgram?this.ws.onOpen(e):this.ws.addEventListener("open",e)},e.prototype.onClose=function(e){n.isMiniProgram?this.ws.onClose(e):this.ws.addEventListener("close",e)},e.prototype.onMessage=function(e){n.isMiniProgram?this.ws.onMessage(e):this.ws.addEventListener("message",e)},e.prototype.onError=function(e){n.isMiniProgram?this.ws.onError(e):this.ws.addEventListener("error",e)},e}();t.WebSocket=o},function(e,t,r){"use strict";(function(e){Object.defineProperty(t,"__esModule",{value:!0}),t.isMiniProgram=function(){try{return!!(wx&&wx.request&&wx.connectSocket)}catch(e){return!1}}(),t.isBrowser=function(){try{return"undefined"!=typeof window&&void 0!==window.document}catch(e){return!1}}(),t.isNode=function(){try{return!!e.versions.node}catch(e){return!1}}(),t.isRN=function(){try{return"ReactNative"===navigator.product}catch(e){return!1}}()}).call(this,r(28))},function(e,t){var r,n,o=e.exports={};function i(){throw new Error("setTimeout has not been defined")}function s(){throw new Error("clearTimeout has not been defined")}function a(e){if(r===setTimeout)return setTimeout(e,0);if((r===i||!r)&&setTimeout)return r=setTimeout,setTimeout(e,0);try{return r(e,0)}catch(t){try{return r.call(null,e,0)}catch(t){return r.call(this,e,0)}}}!function(){try{r="function"==typeof setTimeout?setTimeout:i}catch(e){r=i}try{n="function"==typeof clearTimeout?clearTimeout:s}catch(e){n=s}}();var u,c=[],f=!1,d=-1;function l(){f&&u&&(f=!1,u.length?c=u.concat(c):d=-1,c.length&&p())}function p(){if(!f){var e=a(l);f=!0;for(var t=c.length;t;){for(u=c,c=[];++d<t;)u&&u[d].run();d=-1,t=c.length}u=null,f=!1,function(e){if(n===clearTimeout)return clearTimeout(e);if((n===s||!n)&&clearTimeout)return n=clearTimeout,clearTimeout(e);try{n(e)}catch(t){try{return n.call(null,e)}catch(t){return n.call(this,e)}}}(e)}}function h(e,t){this.fun=e,this.array=t}function _(){}o.nextTick=function(e){var t=new Array(arguments.length-1);if(arguments.length>1)for(var r=1;r<arguments.length;r++)t[r-1]=arguments[r];c.push(new h(e,t)),1!==c.length||f||a(p)},h.prototype.run=function(){this.fun.apply(null,this.array)},o.title="browser",o.browser=!0,o.env={},o.argv=[],o.version="",o.versions={},o.on=_,o.addListener=_,o.once=_,o.off=_,o.removeListener=_,o.removeAllListeners=_,o.emit=_,o.prependListener=_,o.prependOnceListener=_,o.listeners=function(e){return[]},o.binding=function(e){throw new Error("process.binding is not supported")},o.cwd=function(){return"/"},o.chdir=function(e){throw new Error("process.chdir is not supported")},o.umask=function(){return 0}},function(e,t){const r="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";t.encodeBase64=e=>{if(!e)return!1;let t,n,o,i,s,a,u,c="",f=0;do{t=e.charCodeAt(f++),n=e.charCodeAt(f++),o=e.charCodeAt(f++),i=t>>2,s=(3&t)<<4|n>>4,a=(15&n)<<2|o>>6,u=63&o,isNaN(n)?a=u=64:isNaN(o)&&(u=64),c+=r.charAt(i)+r.charAt(s)+r.charAt(a)+r.charAt(u)}while(f<e.length);return c},t.decodeBase64=e=>{if(!e)return!1;e=e.replace(/[^A-Za-z0-9\+\/\=]/g,"");let t,n,o,i,s="",a=0;do{t=r.indexOf(e.charAt(a++)),n=r.indexOf(e.charAt(a++)),o=r.indexOf(e.charAt(a++)),i=r.indexOf(e.charAt(a++)),s+=String.fromCharCode(t<<2|n>>4),64!=o&&(s+=String.fromCharCode((15&n)<<4|o>>2)),64!=i&&(s+=String.fromCharCode((3&o)<<6|i))}while(a<e.length);return s}},function(e,t,r){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),function(e){e.ready="ready",e.error="error",e.wsError="ws_error",e.wsClose="ws_close",e.wsPush="wsPush",e.wsReport="wsReport",e.wsControl="wsControl",e.wsStatusChange="wsStatusChange"}(t.EventTypes||(t.EventTypes={}))},function(e,t,r){"use strict";var n;Object.defineProperty(t,"__esModule",{value:!0});var o=r(0),i=r(2),s=r(5),a=o.__importDefault(r(3));t.SoftApErrorCodes={UDP_NOT_RESPONSED:"UDP_NOT_RESPONSED",SSID_NOT_MATCH:"SSID_NOT_MATCH",CONNECT_SOFTAP_FAIL:"CONNECT_SOFTAP_FAIL",CONNECT_WIFI_FAIL:"CONNECT_WIFI_FAIL",UDP_ERROR:"UDP_ERROR",UDP_CLOSED:"UDP_CLOSED",DEVICE_ERROR:"DEVICE_ERROR",INVALID_RESPONSE:"INVALID_RESPONSE",DEVICE_CONNECT_MQTT_FAIL:"DEVICE_CONNECT_MQTT_FAIL",DEVICE_CONNECT_WIFI_FAIL:"DEVICE_CONNECT_WIFI_FAIL",ADD_DEVICE_FAIL:"ADD_DEVICE_FAIL",SEND_UDP_MSG_FAIL:"SEND_UDP_MSG_FAIL"},t.SoftApErrorMsgs=((n={})[t.SoftApErrorCodes.UDP_NOT_RESPONSED]="超时未收到设备响应",n[t.SoftApErrorCodes.CONNECT_SOFTAP_FAIL]="手机连接设备热点失败",n[t.SoftApErrorCodes.CONNECT_WIFI_FAIL]="手机连接WiFi路由器失败",n[t.SoftApErrorCodes.UDP_ERROR]="连接设备失败",n[t.SoftApErrorCodes.UDP_CLOSED]="连接设备中断",n[t.SoftApErrorCodes.DEVICE_ERROR]="设备配网异常",n[t.SoftApErrorCodes.INVALID_RESPONSE]="设备响应报文格式错误",n[t.SoftApErrorCodes.DEVICE_CONNECT_MQTT_FAIL]="连接云端失败",n[t.SoftApErrorCodes.DEVICE_CONNECT_WIFI_FAIL]="设备连接WiFi路由器失败",n[t.SoftApErrorCodes.ADD_DEVICE_FAIL]="添加设备失败",n[t.SoftApErrorCodes.SEND_UDP_MSG_FAIL]="发送配网消息失败",n),t.SoftApStepCodes={};var u=function(e){var t=new Uint8Array(e),r=String.fromCharCode.apply(null,t);return decodeURIComponent(escape(r))},c=["手机与设备连接成功","向设备发送信息成功","设备连接云端成功","初始化成功"],f=function(e,t,r){return void 0===t&&(t=""),void 0===r&&(r={}),o.__awaiter(void 0,void 0,void 0,(function(){return o.__generator(this,(function(n){switch(n.label){case 0:return wx.hideToast(),[4,s.pify(wx.showModal)(o.__assign({title:e,content:t},r)).then((function(e){return!!e.confirm})).catch((function(){return!1}))];case 1:return[2,n.sent()]}}))}))};t.connectSoftAp=function(e,r){var n=r.targetWifiInfo,d=r.softApInfo,l=r.familyId,p=void 0===l?"default":l,h=r.udpAddress,_=void 0===h?"192.168.4.1":h,v=r.udpPort,g=void 0===v?8266:v,y=r.waitUdpResponseDuration,m=void 0===y?2e3:y,w=r.udpCommunicationRetryTime,b=void 0===w?5:w,E=r.stepDurationGap,I=void 0===E?3e3:E,P=r.onProgress,S=void 0===P?i.noop:P,C=r.onError,A=void 0===C?i.noop:C,O=r.onComplete,T=void 0===O?i.noop:O;return o.__awaiter(this,void 0,void 0,(function(){var r,l,h,v,y,w,E,P,C,O=this;return o.__generator(this,(function(D){switch(D.label){case 0:return D.trys.push([0,7,,8]),l=function(e){a.default.debug("softap-receive-unhandled-msg",{data:{message:e}})},h=function(e){var t=e.step,r=e.data,n=void 0===r?{}:r;S({step:t,msg:c[t-1],data:n})},v=function(e){"string"!=typeof e&&(e=JSON.stringify(e)),console.log("udpInstance.send",{address:_,port:g,message:e}),r.send({address:_,port:g,message:e})},y=function(e){return o.__awaiter(O,void 0,void 0,(function(){var r=this;return o.__generator(this,(function(n){return[2,new Promise((function(n,s){return o.__awaiter(r,void 0,void 0,(function(){var r,u,c,f;return o.__generator(this,(function(o){switch(o.label){case 0:o.trys.push([0,4,,5]),r=!0,u=0,l=function(e){try{r=!1,n(e)}catch(e){s(e)}},(c=function(){u++,a.default.debug("softap-udp-send-msg",{data:{msg:e,retryCount:u}}),v(e)})(),o.label=1;case 1:return r&&u<=b?[4,i.delay(m)]:[3,3];case 2:return o.sent(),r?(c(),[3,1]):[2];case 3:return s({code:t.SoftApErrorCodes.UDP_NOT_RESPONSED}),[3,5];case 4:return f=o.sent(),s({code:t.SoftApErrorCodes.SEND_UDP_MSG_FAIL,detail:{error:f}}),[3,5];case 5:return[2]}}))}))}))]}))}))},w=function(e){var r=e.SSID,n=e.password;return o.__awaiter(O,void 0,void 0,(function(){return o.__generator(this,(function(e){switch(e.label){case 0:return[4,s.pify(wx.connectWifi)({SSID:r,password:n})];case 1:return e.sent(),[4,s.pify(wx.getConnectedWifi)()];case 2:if(e.sent().wifi.SSID!==r)throw{code:t.SoftApErrorCodes.SSID_NOT_MATCH};return a.default.debug("softap-connect-wifi-success"),[2]}}))}))},E=function(){return o.__awaiter(O,void 0,void 0,(function(){var s,c,d,_,v,g,m=this;return o.__generator(this,(function(b){switch(b.label){case 0:s=!1,b.label=1;case 1:return b.trys.push([1,3,,4]),a.default.debug("softap-connect-start"),(r=wx.createUDPSocket()).bind(),c=i.genPromise(),d=i.genPromise(),_=i.genPromise(),r.onError((function(e){return c.reject({code:t.SoftApErrorCodes.UDP_ERROR,detail:{errMsg:e}})})),r.onMessage((function(e){try{var r=JSON.parse(u(e.message));a.default.debug("softap-udp-on-message",{data:{message:r}}),2==+r.cmdType&&("Current_Error"===r.deviceReply?_.reject({code:t.SoftApErrorCodes.DEVICE_ERROR,detail:r}):"Previous_Error"===r.deviceReply?a.default.debug("softap-receive-prev-error",{data:{message:r}}):l(r))}catch(e){a.default.debug("softap-udp-parse-message-error",{error:e})}})),v=function(){return o.__awaiter(m,void 0,void 0,(function(){var u,c,d,l,_,v,g,m,b,E=this;return o.__generator(this,(function(P){switch(P.label){case 0:return[4,(u=function(e){return void 0===e&&(e=I),o.__awaiter(E,void 0,void 0,(function(){return o.__generator(this,(function(t){switch(t.label){case 0:return[4,i.delay(e)];case 1:if(t.sent(),s)throw a.default.debug("connection aborted"),null;return[2]}}))}))})()];case 1:return P.sent(),a.default.debug("softap-create-udp-connection-success"),h({step:1}),a.default.debug("softap-send-target-wifi-start"),[4,y({cmdType:1,ssid:n.SSID,password:n.password})];case 2:if(c=P.sent(),a.default.debug("softap-send-target-wifi-success",{data:c}),"dataRecived"!==c.deviceReply)throw{code:t.SoftApErrorCodes.INVALID_RESPONSE,detail:c};return[4,u(5e3)];case 3:return P.sent(),h({step:2,data:c}),a.default.debug("softap-send-timestamp-start"),[4,y({cmdType:0,timestamp:parseInt(String(Date.now()/1e3))})];case 4:if(d=P.sent(),l=d.mqttState,_=d.wifiState,v=o.__rest(d,["mqttState","wifiState"]),"connected"!==l)throw{code:t.SoftApErrorCodes.DEVICE_CONNECT_MQTT_FAIL};if("connected"!==_)throw{code:t.SoftApErrorCodes.DEVICE_CONNECT_WIFI_FAIL};return a.default.debug("softap-send-timestamp-success",{data:v}),r.close(),[4,u()];case 5:P.sent(),h({step:3,data:o.__assign({mqttState:l,wifiState:_},v)}),a.default.debug("softap-reconnect-wifi-start"),P.label=6;case 6:return P.trys.push([6,8,,10]),[4,w(n)];case 7:return P.sent(),[3,10];case 8:return g=P.sent(),[4,f("手机连接路由Wi-Fi失败，请将手机手动切换到能够正常访问的网络环境后继续配网操作","",{confirmText:"继续",confirmColor:"#0052d9",cancelText:"取消",cancelColor:"#ff584c"})];case 9:if(!P.sent())throw{code:t.SoftApErrorCodes.CONNECT_WIFI_FAIL,detail:{error:g}};return[3,10];case 10:return a.default.debug("softap-reconnect-wifi-success"),[4,u()];case 11:return P.sent(),a.default.debug("softap-add-device-start",{data:{Signature:v.signature,DeviceTimestamp:v.timestamp,ProductId:v.productId,DeviceName:v.deviceName,ConnId:v.connId}}),[4,(m=function(){return o.__awaiter(E,void 0,void 0,(function(){var r;return o.__generator(this,(function(n){switch(n.label){case 0:return n.trys.push([0,2,,7]),[4,e.requestApi("AppSigBindDeviceInFamily",{Signature:v.signature,DeviceTimestamp:v.timestamp,ProductId:v.productId,DeviceName:v.deviceName,ConnId:v.connId,FamilyId:p||"default"})];case 1:return[2,n.sent()];case 2:return(r=n.sent())?r.errMsg&&/request:fail/.test(r.errMsg)?[4,f("手机切换到该网络环境后依然无法正常上网访问，请继续切换网络重试或取消配网操作","",{confirmText:"重试",confirmColor:"#0052d9",cancelText:"取消",cancelColor:"#ff584c"})]:[3,4]:[3,6];case 3:return n.sent()?[2,m()]:[2,Promise.reject({code:t.SoftApErrorCodes.ADD_DEVICE_FAIL,detail:{error:r}})];case 4:return[4,f(i.getErrorMsg(r),"",{confirmText:"重试",confirmColor:"#0052d9",cancelText:"取消",cancelColor:"#ff584c"})];case 5:return n.sent()?[2,m()]:(r.code=t.SoftApErrorCodes.ADD_DEVICE_FAIL,[2,Promise.reject({code:t.SoftApErrorCodes.ADD_DEVICE_FAIL,detail:{error:r},msg:i.getErrorMsg(r),reqId:r.reqId})]);case 6:return[2,Promise.reject(r)];case 7:return[2]}}))}))})()];case 12:return b=P.sent(),a.default.debug("softap-connect-success"),h({step:4,data:b}),[2]}}))}))},[4,Promise.race([v(),c.promise,d.promise,_.promise])];case 2:return b.sent(),[3,4];case 3:return g=b.sent(),s=!0,a.default.debug("softap-connect-fail",{error:g}),g&&g.code in t.SoftApErrorCodes&&(g.msg=t.SoftApErrorMsgs[g.code]),[2,Promise.reject(g)];case 4:return[2]}}))}))},[4,s.pify(wx.startWifi)()];case 1:if(D.sent(),!d)return[3,5];D.label=2;case 2:return D.trys.push([2,4,,5]),[4,w(d)];case 3:return D.sent(),[3,5];case 4:if((P=D.sent()).code===t.SoftApErrorCodes.SSID_NOT_MATCH)throw{code:t.SoftApErrorCodes.CONNECT_SOFTAP_FAIL};throw P;case 5:return[4,E()];case 6:return D.sent(),T(),[3,8];case 7:return C=D.sent(),A(C),[3,8];case 8:return[2]}}))}))}}])}));